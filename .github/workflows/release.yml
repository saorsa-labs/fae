name: Release

on:
  push:
    tags:
      - "v*"

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: write

jobs:
  # ── Verify tag matches Cargo.toml version ──────────────────────────
  preflight:
    name: Pre-flight
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Verify tag matches Cargo.toml version
        id: version
        run: |
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"
          CARGO_VERSION=$(grep -m1 '^version' Cargo.toml | sed 's/.*"\(.*\)".*/\1/')
          if [ "$TAG_VERSION" != "$CARGO_VERSION" ]; then
            echo "::error::Tag version ($TAG_VERSION) does not match Cargo.toml ($CARGO_VERSION)"
            exit 1
          fi
          echo "version=$CARGO_VERSION" >> "$GITHUB_OUTPUT"
          echo "Releasing v$CARGO_VERSION"

  # ── Run full test suite before building release artifacts ──────────
  test:
    name: Tests
    needs: preflight
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Run tests
        run: cargo test --all-features

  # ── Build macOS binary (Apple Silicon) ─────────────────────────────
  build-macos:
    name: Build macOS (arm64)
    needs: test
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry & build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-aarch64-release-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-aarch64-release-

      - name: Build release binaries
        run: |
          cargo build --release --features gui
          cargo build --release --bin fae-record-wakeword --no-default-features

      - name: Import signing certificate
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          MACOS_CERTIFICATE_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # Skip signing if certificate is not configured
          if [ -z "$MACOS_CERTIFICATE" ]; then
            echo "::warning::MACOS_CERTIFICATE not set — skipping code signing"
            echo "SIGNING_ENABLED=false" >> "$GITHUB_ENV"
            exit 0
          fi

          echo "SIGNING_ENABLED=true" >> "$GITHUB_ENV"

          CERTIFICATE_PATH="$RUNNER_TEMP/build_certificate.p12"
          KEYCHAIN_PATH="$RUNNER_TEMP/app-signing.keychain-db"

          echo -n "$MACOS_CERTIFICATE" | base64 --decode -o "$CERTIFICATE_PATH"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          security import "$CERTIFICATE_PATH" \
            -P "$MACOS_CERTIFICATE_PASSWORD" \
            -A -t cert -f pkcs12 \
            -k "$KEYCHAIN_PATH"

          security set-key-partition-list \
            -S apple-tool:,apple:,codesign: \
            -s -k "$KEYCHAIN_PASSWORD" \
            "$KEYCHAIN_PATH"

          security list-keychain -d user -s "$KEYCHAIN_PATH"

      - name: Sign binaries
        if: env.SIGNING_ENABLED == 'true'
        env:
          MACOS_SIGNING_IDENTITY: ${{ secrets.MACOS_SIGNING_IDENTITY }}
        run: |
          codesign --force --options runtime \
            --sign "$MACOS_SIGNING_IDENTITY" \
            --timestamp \
            target/release/fae

          codesign --force --options runtime \
            --sign "$MACOS_SIGNING_IDENTITY" \
            --timestamp \
            target/release/fae-record-wakeword

      - name: Notarize binaries
        if: env.SIGNING_ENABLED == 'true'
        env:
          MACOS_NOTARIZATION_APPLE_ID: ${{ secrets.MACOS_NOTARIZATION_APPLE_ID }}
          MACOS_NOTARIZATION_PASSWORD: ${{ secrets.MACOS_NOTARIZATION_PASSWORD }}
          MACOS_NOTARIZATION_TEAM_ID: ${{ secrets.MACOS_NOTARIZATION_TEAM_ID }}
        run: |
          NOTARIZE_ZIP="$RUNNER_TEMP/fae-notarize.zip"
          ditto -c -k --keepParent target/release/fae "$NOTARIZE_ZIP"

          xcrun notarytool submit "$NOTARIZE_ZIP" \
            --apple-id "$MACOS_NOTARIZATION_APPLE_ID" \
            --password "$MACOS_NOTARIZATION_PASSWORD" \
            --team-id "$MACOS_NOTARIZATION_TEAM_ID" \
            --wait

          NOTARIZE_ZIP2="$RUNNER_TEMP/fae-wakeword-notarize.zip"
          ditto -c -k --keepParent target/release/fae-record-wakeword "$NOTARIZE_ZIP2"

          xcrun notarytool submit "$NOTARIZE_ZIP2" \
            --apple-id "$MACOS_NOTARIZATION_APPLE_ID" \
            --password "$MACOS_NOTARIZATION_PASSWORD" \
            --team-id "$MACOS_NOTARIZATION_TEAM_ID" \
            --wait

      - name: Download Pi coding agent binary
        env:
          PI_VERSION: "latest"
        run: |
          PI_ASSET="pi-darwin-arm64.tar.gz"
          PI_URL="https://github.com/badlogic/pi-mono/releases/${PI_VERSION}/download/${PI_ASSET}"

          echo "Downloading Pi from ${PI_URL}"
          curl -fsSL -o "/tmp/${PI_ASSET}" "${PI_URL}"

          # Extract Pi binary from the tarball (pi/pi inside the archive)
          mkdir -p /tmp/pi-extract
          tar xzf "/tmp/${PI_ASSET}" -C /tmp/pi-extract
          if [ -f /tmp/pi-extract/pi/pi ]; then
            echo "PI_BINARY=/tmp/pi-extract/pi/pi" >> "$GITHUB_ENV"
          else
            echo "::error::Pi binary not found at expected path in archive"
            exit 1
          fi

      - name: Sign Pi binary
        if: env.SIGNING_ENABLED == 'true'
        env:
          MACOS_SIGNING_IDENTITY: ${{ secrets.MACOS_SIGNING_IDENTITY }}
        run: |
          codesign --force --options runtime \
            --sign "$MACOS_SIGNING_IDENTITY" \
            --timestamp \
            "$PI_BINARY"

      - name: Prepare release payloads
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          DIST_DIR="$RUNNER_TEMP/fae-dist"
          APP_BUNDLE="$RUNNER_TEMP/Fae.app"
          ARCHIVE_STAGING="$RUNNER_TEMP/fae-archive-staging"
          ARCHIVE="$DIST_DIR/fae-${VERSION}-macos-arm64.tar.gz"
          UPDATE_ASSET="$DIST_DIR/fae-darwin-aarch64"

          rm -rf "$DIST_DIR" "$APP_BUNDLE" "$ARCHIVE_STAGING"
          mkdir -p "$DIST_DIR" "$ARCHIVE_STAGING"
          mkdir -p "$APP_BUNDLE/Contents/MacOS" "$APP_BUNDLE/Contents/Resources"

          # Standalone binary used by in-app self-update.
          cp target/release/fae "$UPDATE_ASSET"
          chmod +x "$UPDATE_ASSET"

          # Build a macOS app bundle for user-friendly installer packaging.
          cp target/release/fae "$APP_BUNDLE/Contents/MacOS/fae"
          cp "${PI_BINARY}" "$APP_BUNDLE/Contents/Resources/pi"
          chmod +x "$APP_BUNDLE/Contents/MacOS/fae" "$APP_BUNDLE/Contents/Resources/pi"
          cat > "$APP_BUNDLE/Contents/Info.plist" <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CFBundleDisplayName</key>
            <string>Fae</string>
            <key>CFBundleExecutable</key>
            <string>fae</string>
            <key>CFBundleIdentifier</key>
            <string>com.saorsa.fae</string>
            <key>CFBundleName</key>
            <string>Fae</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleShortVersionString</key>
            <string>${VERSION}</string>
            <key>CFBundleVersion</key>
            <string>${VERSION}</string>
            <key>LSMinimumSystemVersion</key>
            <string>13.0</string>
          </dict>
          </plist>
          EOF

          # Dev-focused archive (CLI/source users) with bundled Pi.
          cp target/release/fae "$ARCHIVE_STAGING/"
          cp target/release/fae-record-wakeword "$ARCHIVE_STAGING/"
          cp "${PI_BINARY}" "$ARCHIVE_STAGING/pi"
          cp README.md "$ARCHIVE_STAGING/"
          cp LICENSE "$ARCHIVE_STAGING/" 2>/dev/null || true
          chmod +x "$ARCHIVE_STAGING/fae" "$ARCHIVE_STAGING/fae-record-wakeword" "$ARCHIVE_STAGING/pi"
          tar -czf "$ARCHIVE" -C "$ARCHIVE_STAGING" .

          echo "DIST_DIR=$DIST_DIR" >> "$GITHUB_ENV"
          echo "APP_BUNDLE=$APP_BUNDLE" >> "$GITHUB_ENV"
          echo "ARCHIVE=$ARCHIVE" >> "$GITHUB_ENV"
          echo "UPDATE_ASSET=$UPDATE_ASSET" >> "$GITHUB_ENV"

      - name: Sign app bundle
        if: env.SIGNING_ENABLED == 'true'
        env:
          MACOS_SIGNING_IDENTITY: ${{ secrets.MACOS_SIGNING_IDENTITY }}
        run: |
          codesign --force --options runtime \
            --sign "$MACOS_SIGNING_IDENTITY" \
            --timestamp \
            "$APP_BUNDLE/Contents/Resources/pi"

          codesign --force --options runtime \
            --sign "$MACOS_SIGNING_IDENTITY" \
            --timestamp \
            "$APP_BUNDLE/Contents/MacOS/fae"

          codesign --force --options runtime \
            --sign "$MACOS_SIGNING_IDENTITY" \
            --timestamp \
            "$APP_BUNDLE"

          codesign --verify --deep --strict --verbose=2 "$APP_BUNDLE"

      - name: Build macOS installer (.dmg)
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          DMG_STAGING="$RUNNER_TEMP/fae-dmg-staging"
          INSTALLER_DMG="$DIST_DIR/fae-${VERSION}-macos-arm64.dmg"

          rm -rf "$DMG_STAGING" "$INSTALLER_DMG"
          mkdir -p "$DMG_STAGING"
          cp -R "$APP_BUNDLE" "$DMG_STAGING/Fae.app"
          ln -s /Applications "$DMG_STAGING/Applications"

          hdiutil create \
            -volname "Fae" \
            -srcfolder "$DMG_STAGING" \
            -ov \
            -format UDZO \
            "$INSTALLER_DMG"

          echo "INSTALLER_DMG=$INSTALLER_DMG" >> "$GITHUB_ENV"

      - name: Notarize installer (.dmg)
        if: env.SIGNING_ENABLED == 'true'
        env:
          MACOS_NOTARIZATION_APPLE_ID: ${{ secrets.MACOS_NOTARIZATION_APPLE_ID }}
          MACOS_NOTARIZATION_PASSWORD: ${{ secrets.MACOS_NOTARIZATION_PASSWORD }}
          MACOS_NOTARIZATION_TEAM_ID: ${{ secrets.MACOS_NOTARIZATION_TEAM_ID }}
        run: |
          xcrun notarytool submit "$INSTALLER_DMG" \
            --apple-id "$MACOS_NOTARIZATION_APPLE_ID" \
            --password "$MACOS_NOTARIZATION_PASSWORD" \
            --team-id "$MACOS_NOTARIZATION_TEAM_ID" \
            --wait
          xcrun stapler staple "$INSTALLER_DMG"

      - name: Stage release artifacts
        run: |
          ARTIFACTS_DIR="$RUNNER_TEMP/release-artifacts"
          rm -rf "$ARTIFACTS_DIR"
          mkdir -p "$ARTIFACTS_DIR"

          cp "$ARCHIVE" "$ARTIFACTS_DIR/"
          cp "$INSTALLER_DMG" "$ARTIFACTS_DIR/"
          cp "$UPDATE_ASSET" "$ARTIFACTS_DIR/"

          echo "ARTIFACTS_DIR=$ARTIFACTS_DIR" >> "$GITHUB_ENV"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: fae-macos-arm64
          path: ${{ env.ARTIFACTS_DIR }}/*

  # ── Create GitHub Release with all artifacts ───────────────────────
  release:
    name: Create Release
    needs: build-macos
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f

      - name: Generate checksums
        run: |
          cd artifacts
          find . -type f ! -name 'SHA256SUMS.txt' -print0 | sort -z | xargs -0 sha256sum > SHA256SUMS.txt
          cat SHA256SUMS.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            artifacts/**/*.tar.gz
            artifacts/**/*.dmg
            artifacts/**/fae-darwin-aarch64
            artifacts/SHA256SUMS.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
