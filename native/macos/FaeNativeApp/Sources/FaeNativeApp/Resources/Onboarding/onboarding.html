<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Fae ‚Äî Welcome</title>
<style>
  /* =========================================================
     Global Reset and Base
     ========================================================= */
  :root {
    --bg: transparent;
    --warm-gold: #D4A574;
    --warm-gold-rgb: 212, 165, 116;
    --warm-rose: #C4917A;
    --warm-rose-rgb: 196, 145, 122;
    --accent: #E8B88A;
    --accent-rgb: 232, 184, 138;
    --text-primary: rgba(255, 255, 255, 0.92);
    --text-secondary: rgba(255, 255, 255, 0.65);
    --text-muted: rgba(255, 255, 255, 0.40);
    --card-bg: rgba(255, 255, 255, 0.08);
    --card-border: rgba(255, 255, 255, 0.12);
    --green: #6FCF97;
    --green-glow: rgba(111, 207, 151, 0.35);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: transparent;
    min-height: 100vh;
    overflow: hidden;
    font-family: 'Iowan Old Style', 'Palatino Linotype', Palatino, Georgia, serif;
    font-size: 1rem;
    cursor: default;
    color: var(--text-primary);
  }

  /* =========================================================
     Orb Background Layer
     ========================================================= */
  .orb-layer {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    z-index: 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .orb-wrapper {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    /* Entrance: start scaled down, animate to full */
    transform: scale(0.5);
    opacity: 0;
    animation: orbEntrance 1.2s cubic-bezier(0.34, 1.56, 0.64, 1) 0.2s forwards;
  }

  .orb-wrapper.entered {
    animation: orbFloat 4s ease-in-out infinite;
    transform: scale(1);
    opacity: 1;
  }

  @keyframes orbEntrance {
    0% { transform: scale(0.5); opacity: 0; }
    60% { transform: scale(1.04); opacity: 1; }
    100% { transform: scale(1); opacity: 1; }
  }

  @keyframes orbFloat {
    0%, 100% { transform: scale(1) translateY(0); }
    50% { transform: scale(1) translateY(-6px); }
  }

  .orb {
    overflow: visible;
    position: relative;
    transition: filter 0.3s ease;
  }

  .orb:hover {
    filter: brightness(1.12);
  }

  #orbCanvas { display: block; }

  /* pulseCanvas removed ‚Äî fog cloud has no ring system */

  .orb-highlight {
    position: absolute;
    top: 12%; left: 23%;
    width: 20%; height: 13%;
    background: radial-gradient(ellipse, rgba(255,255,255,0.12) 0%, transparent 70%);
    border-radius: 50%;
    transform: rotate(-18deg);
    pointer-events: none;
    animation: highlightShift 12s ease-in-out infinite;
    opacity: 0.7;
  }

  .aura {
    position: absolute;
    border-radius: 50%;
    pointer-events: none;
    border: 1px solid rgba(var(--warm-gold-rgb), 0.08);
  }

  .aura-1 { animation: auraExpand 10s ease-in-out infinite; }
  .aura-2 { animation: auraExpand 10s ease-in-out infinite 3.2s; }
  .aura-3 { animation: auraExpand 10s ease-in-out infinite 6.4s; }

  @keyframes highlightShift {
    0%, 100% { opacity: 0.35; transform: rotate(-18deg) translateY(0); }
    50% { opacity: 0.12; transform: rotate(-12deg) translateY(5px); }
  }

  @keyframes auraExpand {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.06); opacity: 0.35; }
  }

  /* =========================================================
     Screen System ‚Äî Horizontal Slide Transitions
     ========================================================= */
  .screen {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    z-index: 10;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 32px;
    opacity: 0;
    transform: translateX(60px);
    transition: opacity 0.4s ease-out, transform 0.4s ease-out;
    pointer-events: none;
    will-change: transform, opacity;
  }

  .screen.active {
    opacity: 1;
    transform: translateX(0);
    pointer-events: auto;
  }

  .screen.exit-left {
    opacity: 0;
    transform: translateX(-60px);
    pointer-events: none;
    transition: opacity 0.3s ease-in, transform 0.3s ease-in;
  }

  /* =========================================================
     Dot Indicator
     ========================================================= */
  .dot-indicator {
    position: fixed;
    bottom: 32px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 6px;
    z-index: 20;
  }

  .dot-indicator span {
    width: 5px;
    height: 5px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    transition: background 0.4s ease, transform 0.4s ease;
  }

  .dot-indicator span.active {
    background: var(--accent);
    transform: scale(1.3);
  }

  /* =========================================================
     Fae Speech Bubble
     ========================================================= */
  .fae-bubble {
    background: rgba(var(--warm-gold-rgb), 0.12);
    border: 1px solid rgba(var(--warm-gold-rgb), 0.20);
    -webkit-backdrop-filter: blur(20px) saturate(160%);
    backdrop-filter: blur(20px) saturate(160%);
    border-radius: 22px 22px 22px 6px;
    padding: 16px 20px;
    max-width: 340px;
    margin-bottom: 24px;
    font-size: 1rem;
    line-height: 1.6;
    color: var(--text-primary);
    animation: bubbleIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
  }

  @keyframes bubbleIn {
    from { transform: scale(0.88); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }

  /* =========================================================
     Orb Speaking Animation (dots)
     ========================================================= */
  .orb-speaking {
    display: flex;
    align-items: center;
    gap: 4px;
    margin-bottom: 16px;
    height: 12px;
  }

  .orb-speaking .dot {
    width: 5px; height: 5px;
    border-radius: 50%;
    background: rgba(var(--warm-gold-rgb), 0.65);
    animation: dotBounce 1.4s ease-in-out infinite;
  }

  .orb-speaking .dot:nth-child(1) { animation-delay: 0s; }
  .orb-speaking .dot:nth-child(2) { animation-delay: 0.18s; }
  .orb-speaking .dot:nth-child(3) { animation-delay: 0.36s; }

  @keyframes dotBounce {
    0%, 60%, 100% { transform: translateY(0); opacity: 0.5; }
    30% { transform: translateY(-5px); opacity: 1; }
  }

  /* =========================================================
     Primary Action Button
     ========================================================= */
  .btn-primary {
    background: linear-gradient(135deg, rgba(var(--accent-rgb), 0.25), rgba(var(--warm-rose-rgb), 0.20));
    border: 1px solid rgba(var(--accent-rgb), 0.30);
    border-radius: 24px;
    padding: 14px 36px;
    min-height: 48px;
    font-family: 'Iowan Old Style', 'Palatino Linotype', Palatino, Georgia, serif;
    font-size: 0.95rem;
    color: var(--text-primary);
    cursor: pointer;
    letter-spacing: 0.03em;
    transition: background 0.2s ease, transform 0.15s ease, box-shadow 0.2s ease;
    outline: none;
    -webkit-backdrop-filter: blur(16px);
    backdrop-filter: blur(16px);
    margin-top: 24px;
  }

  .btn-primary:hover {
    background: linear-gradient(135deg, rgba(var(--accent-rgb), 0.35), rgba(var(--warm-rose-rgb), 0.30));
    transform: scale(1.03);
    box-shadow: 0 4px 24px rgba(var(--accent-rgb), 0.20);
  }

  .btn-primary:active {
    transform: scale(0.97);
  }

  /* =========================================================
     Screen 1: Welcome
     ========================================================= */
  #screenWelcome {
    text-align: center;
  }

  /* Staggered entrance for welcome screen elements */
  #screenWelcome .orb-speaking {
    opacity: 0;
    animation: fadeSlideUp 0.5s ease-out 1.2s forwards;
  }

  #screenWelcome .fae-bubble {
    opacity: 0;
    animation: fadeSlideUp 0.6s ease-out 1.6s forwards;
  }

  #screenWelcome .tap-hint {
    opacity: 0;
    animation: fadeSlideUp 0.4s ease-out 2.0s forwards;
  }

  #screenWelcome .btn-primary {
    opacity: 0;
    animation: fadeSlideUp 0.5s ease-out 2.2s forwards;
  }

  @keyframes fadeSlideUp {
    0% { opacity: 0; transform: translateY(12px); }
    100% { opacity: 1; transform: translateY(0); }
  }

  .welcome-title {
    font-size: 1.8rem;
    letter-spacing: 0.06em;
    color: var(--text-primary);
    margin-bottom: 6px;
    font-weight: normal;
  }

  .welcome-subtitle {
    font-size: 0.82rem;
    letter-spacing: 0.20em;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 40px;
  }

  /* =========================================================
     Screen 2: Permissions
     ========================================================= */
  #screenPermissions {
    align-items: flex-start;
    max-width: 360px;
    margin: 0 auto;
    overflow-y: auto;
    padding-bottom: 48px; /* ensure Continue button is reachable above dot indicator */
  }

  .permissions-title {
    font-size: 1.2rem;
    letter-spacing: 0.04em;
    color: var(--text-primary);
    margin-bottom: 6px;
    font-weight: normal;
    align-self: center;
  }

  .permissions-subtitle {
    font-size: 0.78rem;
    color: var(--text-muted);
    margin-bottom: 24px;
    align-self: center;
    text-align: center;
    letter-spacing: 0.05em;
  }

  .permission-card {
    width: 100%;
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 20px;
    padding: 20px 22px;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 14px;
    -webkit-backdrop-filter: blur(20px);
    backdrop-filter: blur(20px);
    transition: background 0.2s ease, border-color 0.2s ease;
  }

  .permission-card.granted {
    background: rgba(111, 207, 151, 0.08);
    border-color: rgba(111, 207, 151, 0.22);
  }

  .permission-icon {
    width: 40px; height: 40px;
    border-radius: 12px;
    background: rgba(var(--warm-gold-rgb), 0.15);
    border: 1px solid rgba(var(--warm-gold-rgb), 0.18);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    font-size: 1.1rem;
  }

  .permission-info {
    flex: 1;
    min-width: 0;
  }

  .permission-name {
    font-size: 0.88rem;
    color: var(--text-primary);
    margin-bottom: 2px;
  }

  .permission-desc {
    font-size: 0.74rem;
    color: var(--text-muted);
    line-height: 1.4;
  }

  .permission-actions {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
  }

  .permission-status {
    font-size: 0.72rem;
    letter-spacing: 0.06em;
    padding: 3px 10px;
    border-radius: 10px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    background: rgba(255, 255, 255, 0.05);
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: 'Iowan Old Style', 'Palatino Linotype', Palatino, Georgia, serif;
    outline: none;
  }

  .permission-status.granted {
    background: rgba(111, 207, 151, 0.12);
    border-color: rgba(111, 207, 151, 0.25);
    color: var(--green);
    cursor: default;
  }

  .permission-status.denied {
    background: rgba(239, 68, 68, 0.08);
    border-color: rgba(239, 68, 68, 0.2);
    color: rgba(239, 68, 68, 0.7);
    cursor: pointer;
  }

  .permission-status.settings {
    background: rgba(var(--warm-gold-rgb), 0.10);
    border-color: rgba(var(--warm-gold-rgb), 0.22);
    color: var(--accent);
    cursor: pointer;
    font-size: 0.66rem;
    letter-spacing: 0.03em;
  }

  .btn-help {
    width: 22px; height: 22px;
    border-radius: 50%;
    border: 1px solid rgba(255, 255, 255, 0.12);
    background: rgba(255, 255, 255, 0.05);
    color: var(--text-muted);
    font-size: 0.72rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    flex-shrink: 0;
    outline: none;
    font-family: 'Iowan Old Style', 'Palatino Linotype', Palatino, Georgia, serif;
  }

  .btn-help:hover {
    background: rgba(var(--warm-gold-rgb), 0.15);
    border-color: rgba(var(--warm-gold-rgb), 0.25);
    color: var(--text-secondary);
  }

  /* =========================================================
     Permission Card State Animations
     ========================================================= */

  /* Granted pulse ‚Äî brief scale pop then settle */
  @keyframes cardGrantedPulse {
    0%   { transform: scale(1); }
    30%  { transform: scale(1.025); }
    70%  { transform: scale(0.997); }
    100% { transform: scale(1); }
  }

  /* Denied shake */
  @keyframes cardDeniedShake {
    0%   { transform: translateX(0); }
    15%  { transform: translateX(-6px); }
    40%  { transform: translateX(5px); }
    65%  { transform: translateX(-3px); }
    85%  { transform: translateX(2px); }
    100% { transform: translateX(0); }
  }

  /* Icon swap fade */
  @keyframes iconFadeIn {
    from { opacity: 0; transform: scale(0.7); }
    to   { opacity: 1; transform: scale(1); }
  }

  .permission-card.animate-granted {
    animation: cardGrantedPulse 0.45s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
  }

  .permission-card.animate-denied {
    animation: cardDeniedShake 0.4s ease-out forwards;
  }

  .permission-icon.icon-swap {
    animation: iconFadeIn 0.3s ease-out forwards;
  }

  /* =========================================================
     Privacy Assurance Banner
     ========================================================= */
  .privacy-assurance {
    width: 100%;
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 18px;
    margin-bottom: 4px;
    background: rgba(var(--warm-gold-rgb), 0.06);
    border: 1px solid rgba(var(--warm-gold-rgb), 0.14);
    border-radius: 14px;
    -webkit-backdrop-filter: blur(16px);
    backdrop-filter: blur(16px);
  }

  .privacy-icon {
    font-size: 0.95rem;
    flex-shrink: 0;
    opacity: 0.75;
  }

  .privacy-text {
    flex: 1;
    font-size: 0.72rem;
    color: var(--text-muted);
    line-height: 1.45;
    letter-spacing: 0.02em;
  }

  /* =========================================================
     Screen 3: Ready
     ========================================================= */
  #screenReady {
    text-align: center;
  }

  .ready-greeting {
    font-size: 1.4rem;
    letter-spacing: 0.04em;
    color: var(--text-primary);
    margin-bottom: 8px;
    font-weight: normal;
  }

  .listening-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    justify-content: center;
    margin-bottom: 28px;
  }

  .listening-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    background: var(--green);
    box-shadow: 0 0 8px var(--green-glow);
    animation: listeningPulse 2s ease-in-out infinite;
  }

  @keyframes listeningPulse {
    0%, 100% { box-shadow: 0 0 8px var(--green-glow); }
    50% { box-shadow: 0 0 14px var(--green-glow), 0 0 26px rgba(111, 207, 151, 0.15); }
  }

  .listening-label {
    font-size: 0.78rem;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    color: var(--text-muted);
  }

  /* =========================================================
     Tap Hint
     ========================================================= */
  .tap-hint {
    font-size: 0.78rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-top: 4px;
    opacity: 0.7;
  }

  /* =========================================================
     Light Mode Adaptation
     ========================================================= */
  @media (prefers-color-scheme: light) {
    :root {
      --warm-gold: #B8864A;
      --warm-gold-rgb: 184, 134, 74;
      --warm-rose: #A0705E;
      --warm-rose-rgb: 160, 112, 94;
      --accent: #C8944A;
      --accent-rgb: 200, 148, 74;
      --text-primary: rgba(0, 0, 0, 0.85);
      --text-secondary: rgba(0, 0, 0, 0.60);
      --text-muted: rgba(0, 0, 0, 0.38);
      --card-bg: rgba(255, 255, 255, 0.45);
      --card-border: rgba(0, 0, 0, 0.08);
      --green: #34A853;
      --green-glow: rgba(52, 168, 83, 0.30);
    }

    .orb {
      /* Light mode: no box-shadow needed without border-radius */
    }

    .aura {
      border-color: rgba(var(--warm-gold-rgb), 0.12);
    }

    .dot-indicator span {
      background: rgba(0, 0, 0, 0.15);
    }

    .fae-bubble {
      background: rgba(var(--warm-gold-rgb), 0.10);
      border-color: rgba(var(--warm-gold-rgb), 0.18);
    }

    .orb-speaking .dot {
      background: rgba(var(--warm-gold-rgb), 0.55);
    }

    .btn-primary {
      background: linear-gradient(135deg, rgba(var(--accent-rgb), 0.22), rgba(var(--warm-rose-rgb), 0.18));
      border-color: rgba(var(--accent-rgb), 0.28);
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, rgba(var(--accent-rgb), 0.32), rgba(var(--warm-rose-rgb), 0.26));
      box-shadow: 0 4px 24px rgba(var(--accent-rgb), 0.16);
    }

    .permission-card.granted {
      background: rgba(52, 168, 83, 0.08);
      border-color: rgba(52, 168, 83, 0.20);
    }

    .permission-icon {
      background: rgba(var(--warm-gold-rgb), 0.12);
      border-color: rgba(var(--warm-gold-rgb), 0.16);
    }

    .permission-status {
      border-color: rgba(0, 0, 0, 0.10);
      background: rgba(0, 0, 0, 0.04);
    }

    .permission-status.granted {
      background: rgba(52, 168, 83, 0.10);
      border-color: rgba(52, 168, 83, 0.22);
      color: var(--green);
    }

    .permission-status.denied {
      background: rgba(220, 53, 53, 0.06);
      border-color: rgba(220, 53, 53, 0.16);
      color: rgba(220, 53, 53, 0.75);
    }

    .btn-help {
      border-color: rgba(0, 0, 0, 0.10);
      background: rgba(0, 0, 0, 0.04);
    }

    .btn-help:hover {
      background: rgba(var(--warm-gold-rgb), 0.12);
      border-color: rgba(var(--warm-gold-rgb), 0.22);
    }

    .privacy-assurance {
      background: rgba(var(--warm-gold-rgb), 0.05);
      border-color: rgba(var(--warm-gold-rgb), 0.12);
    }

    .orb-highlight {
      background: radial-gradient(ellipse, rgba(255,255,255,0.18) 0%, transparent 70%);
    }
  }

  /* =========================================================
     Responsive Layout
     ========================================================= */
  .screen {
    padding: clamp(20px, 5vh, 40px) clamp(16px, 4vw, 32px);
  }

  .welcome-title {
    font-size: clamp(1.4rem, 3.5vw, 1.8rem);
  }

  .permissions-title {
    font-size: clamp(1rem, 2.5vw, 1.2rem);
  }

  .fae-bubble {
    max-width: clamp(260px, 70vw, 340px);
    font-size: clamp(0.88rem, 2vw, 1rem);
  }

  #screenPermissions {
    max-width: clamp(300px, 80vw, 400px);
  }

  /* =========================================================
     Download Progress Overlay
     ========================================================= */
  .progress-overlay {
    position: fixed;
    bottom: 50px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 25;
    width: clamp(260px, 70vw, 360px);
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
  }

  .progress-overlay.visible {
    opacity: 1;
  }

  .progress-label {
    font-size: 0.72rem;
    color: var(--text-muted);
    letter-spacing: 0.04em;
    margin-bottom: 6px;
    text-align: center;
  }

  .progress-track {
    width: 100%;
    height: 3px;
    background: rgba(255, 255, 255, 0.08);
    border-radius: 2px;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, var(--warm-gold), var(--accent));
    border-radius: 2px;
    transition: width 0.3s ease;
  }

  /* =========================================================
     Permission Skip Hint
     ========================================================= */
  .skip-hint {
    font-size: 0.72rem;
    color: var(--text-muted);
    letter-spacing: 0.04em;
    margin-top: 8px;
    opacity: 0.6;
    text-align: center;
  }

  /* =========================================================
     Reduced Motion
     ========================================================= */
  @media (prefers-reduced-motion: reduce) {
    .screen {
      transition: opacity 0.2s ease;
      transform: none !important;
    }
    .screen.active {
      transform: none !important;
    }
    .screen.exit-left {
      transform: none !important;
    }
    .orb-wrapper {
      animation: none;
      transform: scale(1);
      opacity: 1;
    }
    .orb-wrapper.entered {
      animation: none;
      transform: scale(1);
    }
    #screenWelcome .orb-speaking,
    #screenWelcome .fae-bubble,
    #screenWelcome .tap-hint,
    #screenWelcome .btn-primary {
      animation: none;
      opacity: 1;
      transform: none;
    }
    .aura { animation: none; }
    .orb-highlight { animation: none; }
    .orb-speaking .dot { animation: none; opacity: 0.65; }
    .listening-dot { animation: none; }
    .fae-bubble { animation: none; opacity: 1; }
    /* Permission card state animations */
    .permission-card.animate-granted,
    .permission-card.animate-denied { animation: none; }
    .permission-icon.icon-swap { animation: none; opacity: 1; transform: none; }
  }

</style>
</head>
<body>

  <!-- =========================================================
       Orb Background Layer (shared aesthetic with conversation.html)
       ========================================================= -->
  <div class="orb-layer" id="scene">
    <div class="aura aura-1" id="aura1"></div>
    <div class="aura aura-2" id="aura2"></div>
    <div class="aura aura-3" id="aura3"></div>

    <div class="orb-wrapper" id="orbWrapper">
      <div class="orb" id="orbContainer">
        <canvas id="orbCanvas"></canvas>
      </div>
      <div class="orb-highlight"></div>
    </div>
  </div>

  <!-- =========================================================
       Screen 1: Welcome
       ========================================================= -->
  <div class="screen active" id="screenWelcome">
    <div class="orb-speaking" id="welcomeSpeaking">
      <span class="dot"></span>
      <span class="dot"></span>
      <span class="dot"></span>
    </div>
    <div class="fae-bubble" id="welcomeBubble">
      Hello. I'm Fae ‚Äî your private, always-available AI companion.
      I live right here on your Mac, and I'm ready to get to know you.
    </div>
    <p class="tap-hint">click anywhere to continue</p>
    <button class="btn-primary" id="btnWelcomeNext">Get started</button>
  </div>

  <!-- =========================================================
       Screen 2: Permissions
       ========================================================= -->
  <div class="screen" id="screenPermissions">
    <p class="permissions-title">A few things to set up</p>
    <p class="permissions-subtitle">These help Fae work naturally with you</p>

    <!-- Microphone Permission Card -->
    <div class="permission-card" id="cardMic">
      <div class="permission-icon" id="iconMic">üéôÔ∏è</div>
      <div class="permission-info">
        <div class="permission-name">Microphone</div>
        <div class="permission-desc">Hear your voice for conversation</div>
      </div>
      <div class="permission-actions">
        <button class="btn-help" data-permission="microphone" aria-label="Learn about microphone permission">?</button>
        <button class="permission-status" id="statusMic" data-permission="microphone">Allow</button>
      </div>
    </div>

    <!-- Contacts Permission Card -->
    <div class="permission-card" id="cardContacts">
      <div class="permission-icon" id="iconContacts">üë§</div>
      <div class="permission-info">
        <div class="permission-name">Contacts</div>
        <div class="permission-desc">Know your name for personalisation</div>
      </div>
      <div class="permission-actions">
        <button class="btn-help" data-permission="contacts" aria-label="Learn about contacts permission">?</button>
        <button class="permission-status" id="statusContacts" data-permission="contacts">Allow</button>
      </div>
    </div>

    <!-- Calendar & Reminders Permission Card -->
    <div class="permission-card" id="cardCalendar">
      <div class="permission-icon" id="iconCalendar">üìÖ</div>
      <div class="permission-info">
        <div class="permission-name">Calendar &amp; Reminders</div>
        <div class="permission-desc">Help manage your schedule</div>
      </div>
      <div class="permission-actions">
        <button class="btn-help" data-permission="calendar" aria-label="Learn about calendar permission">?</button>
        <button class="permission-status" id="statusCalendar" data-permission="calendar">Allow</button>
      </div>
    </div>

    <!-- Mail & Notes Permission Card -->
    <div class="permission-card" id="cardMail">
      <div class="permission-icon" id="iconMail">‚úâÔ∏è</div>
      <div class="permission-info">
        <div class="permission-name">Mail &amp; Notes</div>
        <div class="permission-desc">Help find and compose messages</div>
      </div>
      <div class="permission-actions">
        <button class="btn-help" data-permission="mail" aria-label="Learn about mail permission">?</button>
        <button class="permission-status" id="statusMail" data-permission="mail">Allow</button>
      </div>
    </div>

    <!-- Privacy Assurance Banner -->
    <div class="privacy-assurance" id="privacyAssurance">
      <div class="privacy-icon">üîí</div>
      <div class="privacy-text">Everything stays on your Mac. I never send data anywhere.</div>
      <button class="btn-help" data-permission="privacy" aria-label="Learn about privacy">?</button>
    </div>

    <button class="btn-primary" id="btnPermissionsNext">Continue</button>
    <p class="skip-hint" id="skipHint">You can set these up later in Settings</p>
  </div>

  <!-- =========================================================
       Screen 3: Ready
       ========================================================= -->
  <div class="screen" id="screenReady">
    <div class="orb-speaking" id="readySpeaking">
      <span class="dot"></span>
      <span class="dot"></span>
      <span class="dot"></span>
    </div>
    <div class="fae-bubble" id="readyBubble">
      I'm all set. Just speak ‚Äî I'm always here, always listening,
      and everything stays right here on your Mac.
    </div>
    <div class="listening-indicator">
      <div class="listening-dot"></div>
      <span class="listening-label">Listening</span>
    </div>
    <button class="btn-primary" id="btnReady">Start conversation</button>
  </div>

  <!-- =========================================================
       Download Progress Overlay
       ========================================================= -->
  <div class="progress-overlay" id="progressOverlay">
    <div class="progress-label" id="progressLabel">Loading‚Ä¶</div>
    <div class="progress-track">
      <div class="progress-fill" id="progressFill"></div>
    </div>
  </div>

  <!-- =========================================================
       Dot Indicator
       ========================================================= -->
  <div class="dot-indicator">
    <span class="active" id="dot0"></span>
    <span id="dot1"></span>
    <span id="dot2"></span>
  </div>

<script>
/* =========================================================
   Fae Onboarding ‚Äî Orb Animation + Screen State Machine
   ========================================================= */

/* ---------------------------------------------------------
   0. Helper: post to Swift
   --------------------------------------------------------- */
function postToSwift(handler, data) {
  if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers[handler]) {
    window.webkit.messageHandlers[handler].postMessage(data || {});
  }
}

/* ---------------------------------------------------------
   1. HSL Color Utilities (same as conversation.html)
   --------------------------------------------------------- */
function hexToRgb(hex) {
  var c = hex.replace("#", "");
  var n = parseInt(c, 16);
  return { r: (n >> 16) & 255, g: (n >> 8) & 255, b: n & 255 };
}

function hexToHsl(hex) {
  var c = hexToRgb(hex);
  var r = c.r / 255, g = c.g / 255, b = c.b / 255;
  var mx = Math.max(r, g, b), mn = Math.min(r, g, b);
  var h = 0, s = 0, l = (mx + mn) / 2;
  if (mx !== mn) {
    var d = mx - mn;
    s = l > 0.5 ? d / (2 - mx - mn) : d / (mx + mn);
    if (mx === r) h = ((g - b) / d + (g < b ? 6 : 0)) / 6;
    else if (mx === g) h = ((b - r) / d + 2) / 6;
    else h = ((r - g) / d + 4) / 6;
  }
  return { h: h * 360, s: s * 100, l: l * 100 };
}

function hslToRgb(h, s, l) {
  h = ((h % 360) + 360) % 360;
  var S = s / 100, L = l / 100;
  var c = (1 - Math.abs(2 * L - 1)) * S;
  var x = c * (1 - Math.abs((h / 60) % 2 - 1));
  var m = L - c / 2;
  var r = 0, g = 0, b = 0;
  if (h < 60) { r = c; g = x; }
  else if (h < 120) { r = x; g = c; }
  else if (h < 180) { g = c; b = x; }
  else if (h < 240) { g = x; b = c; }
  else if (h < 300) { r = x; b = c; }
  else { r = c; b = x; }
  return { r: Math.round((r + m) * 255), g: Math.round((g + m) * 255), b: Math.round((b + m) * 255) };
}

function lerpHsl(from, to, t) {
  var dh = to.h - from.h;
  if (dh > 180) dh -= 360;
  if (dh < -180) dh += 360;
  return { h: from.h + dh * t, s: from.s + (to.s - from.s) * t, l: from.l + (to.l - from.l) * t };
}

function hslToHex(h, s, l) {
  var rgb = hslToRgb(h, s, l);
  return "#" + ((1 << 24) | (rgb.r << 16) | (rgb.g << 8) | rgb.b).toString(16).slice(1);
}

function lerpColorHex(fromHex, toHex, t) {
  var a = hexToHsl(fromHex);
  var b = hexToHsl(toHex);
  var c = lerpHsl(a, b, t);
  return hslToHex(c.h, c.s, c.l);
}

function lerpN(a, b, t) { return a + (b - a) * t; }

/* ---------------------------------------------------------
   2. Inline 2D Simplex Noise
   --------------------------------------------------------- */
var SimplexNoise = (function() {
  var F2 = 0.5 * (Math.sqrt(3) - 1);
  var G2 = (3 - Math.sqrt(3)) / 6;
  var grad3 = [[1,1],[-1,1],[1,-1],[-1,-1],[1,0],[-1,0],[0,1],[0,-1]];

  function SimplexNoise(seed) {
    this.perm = new Uint8Array(512);
    this.permMod8 = new Uint8Array(512);
    var p = new Uint8Array(256);
    var s = seed || Math.random() * 2147483647;
    for (var i = 0; i < 256; i++) { p[i] = i; }
    for (var i = 255; i > 0; i--) {
      s = (s * 16807 + 0) % 2147483647;
      var j = s % (i + 1);
      var tmp = p[i]; p[i] = p[j]; p[j] = tmp;
    }
    for (var i = 0; i < 512; i++) {
      this.perm[i] = p[i & 255];
      this.permMod8[i] = this.perm[i] % 8;
    }
  }

  SimplexNoise.prototype.noise2D = function(xin, yin) {
    var s = (xin + yin) * F2;
    var i = Math.floor(xin + s);
    var j = Math.floor(yin + s);
    var t = (i + j) * G2;
    var x0 = xin - (i - t), y0 = yin - (j - t);
    var i1, j1;
    if (x0 > y0) { i1 = 1; j1 = 0; } else { i1 = 0; j1 = 1; }
    var x1 = x0 - i1 + G2, y1 = y0 - j1 + G2;
    var x2 = x0 - 1 + 2 * G2, y2 = y0 - 1 + 2 * G2;
    var ii = i & 255, jj = j & 255;
    var n0 = 0, n1 = 0, n2 = 0;
    var t0 = 0.5 - x0 * x0 - y0 * y0;
    if (t0 >= 0) { t0 *= t0; var gi0 = this.permMod8[ii + this.perm[jj]]; n0 = t0 * t0 * (grad3[gi0][0] * x0 + grad3[gi0][1] * y0); }
    var t1 = 0.5 - x1 * x1 - y1 * y1;
    if (t1 >= 0) { t1 *= t1; var gi1 = this.permMod8[ii + i1 + this.perm[jj + j1]]; n1 = t1 * t1 * (grad3[gi1][0] * x1 + grad3[gi1][1] * y1); }
    var t2 = 0.5 - x2 * x2 - y2 * y2;
    if (t2 >= 0) { t2 *= t2; var gi2 = this.permMod8[ii + 1 + this.perm[jj + 1]]; n2 = t2 * t2 * (grad3[gi2][0] * x2 + grad3[gi2][1] * y2); }
    return 70 * (n0 + n1 + n2);
  };

  return SimplexNoise;
})();

var noise = new SimplexNoise(42);

/* ---------------------------------------------------------
   3. Orb State
   --------------------------------------------------------- */
var PALETTE_DARK = {
  warmGold: "#D4A574",
  warmRose: "#C4917A",
  softAmber: "#E8B88A",
  warmCream: "#F0DCC8",
  dawnLight: "#E8DED2"
};

var PALETTE_LIGHT = {
  warmGold: "#B8864A",
  warmRose: "#A0705E",
  softAmber: "#C8944A",
  warmCream: "#D4B896",
  dawnLight: "#C8B8A4"
};

var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches;
var PALETTE = isDarkMode ? PALETTE_DARK : PALETTE_LIGHT;

var orbMode = "speaking";
var orbColors = [PALETTE.warmGold, PALETTE.warmRose, PALETTE.warmCream];
var reducedMotion = window.matchMedia("(prefers-reduced-motion: reduce)").matches;

/* Scottish palette for color cycling during onboarding */
var SCOTTISH_PALETTE = [
  { colors: ["#B4A8C4", "#9B8FB4", "#C4B8D4"] },  /* Heather */
  { colors: ["#D4A574", "#C4917A", "#E8B88A"] },  /* Warm Gold */
  { colors: ["#8BA5A0", "#7A9692", "#9CB5B0"] },  /* Sea Glass */
  { colors: ["#A0B090", "#90A080", "#B0C0A0"] },  /* Moss */
  { colors: ["#C4917A", "#B48070", "#D4A18A"] },  /* Rose Clay */
  { colors: ["#6B8E8A", "#5A7D79", "#7C9F9B"] },  /* Deep Teal */
  { colors: ["#C8B896", "#B8A886", "#D8C8A6"] },  /* Oat */
  { colors: ["#8E7A6E", "#7E6A5E", "#9E8A7E"] }   /* Peat */
];
var colorCycleIdx = 0;
var colorCycleT = 0;
var colorCycleSpeed = 0.15; /* Complete cycle every ~6.7 seconds */

/* Listen for color scheme changes and update UI palette live.
   The orb fog cloud colors are now driven by Scottish palette cycling,
   so we only update the PALETTE used by UI elements. */
window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", function(e) {
  isDarkMode = e.matches;
  PALETTE = isDarkMode ? PALETTE_DARK : PALETTE_LIGHT;
});

/* ---------------------------------------------------------
   4. Canvas Setup
   --------------------------------------------------------- */
var orbCanvas = document.getElementById("orbCanvas");
var orbCtx = orbCanvas.getContext("2d");
var orbWrapper = document.getElementById("orbWrapper");
var orbContainer = document.getElementById("orbContainer");
var aura1 = document.getElementById("aura1");
var aura2 = document.getElementById("aura2");
var aura3 = document.getElementById("aura3");

var grainCanvas = document.createElement("canvas");
var grainCtx = grainCanvas.getContext("2d");
var grainPattern = null;
var grainTileSize = 128;

var orbDiameter, orbRadius, canvasSize, dpr;

function recalcSize() {
  var vw = window.innerWidth;
  var vh = window.innerHeight;
  orbDiameter = Math.round(Math.min(vw, vh) * 0.62);
  orbRadius = orbDiameter / 2;
  dpr = window.devicePixelRatio || 1;
  /* 1.4x multiplier so fog cloud overflow isn't clipped */
  var fogDiameter = Math.round(orbDiameter * 1.4);
  canvasSize = Math.round(fogDiameter * dpr);

  orbCanvas.width = canvasSize; orbCanvas.height = canvasSize;
  orbCanvas.style.width = fogDiameter + "px"; orbCanvas.style.height = fogDiameter + "px";
  orbContainer.style.width = fogDiameter + "px"; orbContainer.style.height = fogDiameter + "px";
  orbWrapper.style.width = fogDiameter + "px"; orbWrapper.style.height = fogDiameter + "px";

  var a1 = Math.round(orbDiameter * 1.19);
  var a2 = Math.round(orbDiameter * 1.41);
  var a3 = Math.round(orbDiameter * 1.63);
  aura1.style.width = a1 + "px"; aura1.style.height = a1 + "px";
  aura2.style.width = a2 + "px"; aura2.style.height = a2 + "px";
  aura3.style.width = a3 + "px"; aura3.style.height = a3 + "px";

  grainCanvas.width = grainTileSize; grainCanvas.height = grainTileSize;
  regenerateGrain();
}

recalcSize();
if (typeof ResizeObserver !== "undefined") {
  new ResizeObserver(function() { recalcSize(); }).observe(document.body);
} else {
  window.addEventListener("resize", recalcSize);
}

/* ---------------------------------------------------------
   5. Grain
   --------------------------------------------------------- */
function regenerateGrain() {
  var w = grainCanvas.width, h = grainCanvas.height;
  if (w === 0 || h === 0) return;
  var imgData = grainCtx.createImageData(w, h);
  var data = imgData.data;
  for (var i = 0; i < data.length; i += 4) {
    var v = Math.random() * 255;
    data[i] = v; data[i + 1] = v; data[i + 2] = v; data[i + 3] = 255;
  }
  grainCtx.putImageData(imgData, 0, 0);
  grainPattern = orbCtx.createPattern(grainCanvas, "repeat");
}

/* ---------------------------------------------------------
   6. Fog Cloud Elements: Blobs, Wisps, Stars
   --------------------------------------------------------- */
var FOG_LAYERS = 6;
var BLOB_COUNT = reducedMotion ? 6 : 14;
var STAR_COUNT = reducedMotion ? 0 : 80;
var OUTER_STAR_COUNT = reducedMotion ? 0 : 16;
var WISP_COUNT = reducedMotion ? 0 : 8;

/* Blobs ‚Äî internal flowing fog motion */
var blobs = [];
for (var bi = 0; bi < 14; bi++) {
  blobs.push({
    orbitRadius: 0.08 + (bi / 14) * 0.38,
    phaseOffset: (bi * 2.399) % (Math.PI * 2),
    speedVariance: 0.7 + Math.random() * 0.6,
    noiseSeed: bi * 137.5,
    colorIdx: bi % 3
  });
}

/* Wisps ‚Äî smooth round fog puffs at boundary */
var wisps = [];
for (var wi = 0; wi < 8; wi++) {
  wisps.push({
    baseAngle: (wi / 8) * Math.PI * 2 + (Math.random() - 0.5) * 0.8,
    dist: 0.6 + Math.random() * 0.35,
    sizeBase: 0.7 + Math.random() * 0.6,
    driftSpeed: 0.03 + Math.random() * 0.08,
    noiseSeed: wi * 345,
    alphaBase: 0.7 + Math.random() * 0.6,
    colorIdx: wi % 3
  });
}

/* ---------------------------------------------------------
   7. Star System ‚Äî tiny twinkling points in fog
   --------------------------------------------------------- */
function spawnStar(nowSec, outer) {
  var angle = Math.random() * Math.PI * 2;
  var dist = outer
    ? (0.7 + Math.random() * 0.35)
    : (0.04 + Math.random() * 0.62);
  var isBright = Math.random() < 0.06;
  return {
    angle: angle,
    dist: dist,
    speed: 0.015 + Math.random() * 0.12,
    size: isBright ? (0.8 + Math.random() * 0.5) : (0.2 + Math.random() * 0.7),
    born: nowSec,
    lifespan: 3 + Math.random() * 8,
    noiseSeed: Math.random() * 1000,
    colorIdx: Math.floor(Math.random() * 3),
    bright: isBright,
    twinkleRate: 1.5 + Math.random() * 4,
    twinklePhase: Math.random() * Math.PI * 2,
    outer: outer || false
  };
}

var stars = [];
for (var si = 0; si < STAR_COUNT; si++) {
  var s = spawnStar(0, false);
  s.born = -(Math.random() * s.lifespan);
  stars.push(s);
}
for (var si = 0; si < OUTER_STAR_COUNT; si++) {
  var s = spawnStar(0, true);
  s.born = -(Math.random() * s.lifespan);
  stars.push(s);
}

/* ---------------------------------------------------------
   8. Fog Cloud Drawing ‚Äî color cycling through Scottish palette
   --------------------------------------------------------- */
function drawOrb(nowSec) {
  var W = orbCanvas.width;
  var H = orbCanvas.height;
  var CX = W / 2;
  var CY = H / 2;
  /* Fog cloud base radius ‚Äî tight Warm Whisper style */
  var R = W / 2 * 0.42;

  var colors = orbColors.map(hexToRgb);
  orbCtx.clearRect(0, 0, W, H);

  /* Breathing */
  var throb = 1 + Math.sin(nowSec * 0.42) * 0.012;

  /* Organic shape: morph displacement for fog center drift */
  var driftX = noise.noise2D(nowSec * 0.08, 0) * R * 0.06;
  var driftY = noise.noise2D(0, nowSec * 0.08 + 50) * R * 0.06;

  /* Morph displacement field for organic boundary shape */
  var MSEG = 32;
  var morphPoints = [];
  var amp = reducedMotion ? 0.02 : 0.06;
  var mFreq = 2;
  var mSpeed = reducedMotion ? 0.02 : 0.18;
  for (var mi = 0; mi < MSEG; mi++) {
    var angle = (mi / MSEG) * Math.PI * 2;
    var n1 = noise.noise2D(Math.cos(angle) * mFreq + nowSec * mSpeed,
                           Math.sin(angle) * mFreq + nowSec * mSpeed * 0.7);
    var n2 = noise.noise2D(Math.cos(angle) * (mFreq * 0.5) + nowSec * mSpeed * 0.3 + 100,
                           Math.sin(angle) * (mFreq * 0.5) + nowSec * mSpeed * 0.2 + 100);
    var disp = n1 * amp * 0.7 + n2 * amp * 0.3;
    morphPoints.push(1 + disp);
  }

  /* Helper: get morph scale at any angle */
  function getMorphAt(a) {
    var t = ((a % (Math.PI * 2)) + Math.PI * 2) % (Math.PI * 2);
    var idx = (t / (Math.PI * 2)) * MSEG;
    var i0 = Math.floor(idx) % MSEG;
    var i1 = (i0 + 1) % MSEG;
    var frac = idx - Math.floor(idx);
    return morphPoints[i0] * (1 - frac) + morphPoints[i1] * frac;
  }

  orbCtx.save();
  orbCtx.translate(CX, CY);
  orbCtx.scale(throb, throb);
  orbCtx.translate(-CX, -CY);

  /* ---- SMOOTH ROUND WISPS (soft fog puffs at boundary) ---- */
  if (!reducedMotion) {
    for (var wi = 0; wi < WISP_COUNT; wi++) {
      var wisp = wisps[wi];
      var wAngle = wisp.baseAngle + noise.noise2D(wisp.noiseSeed + nowSec * wisp.driftSpeed, wi * 3) * 0.6;
      var wDist = wisp.dist * R * getMorphAt(wAngle);
      var wx = CX + Math.cos(wAngle) * wDist + driftX * 0.5;
      var wy = CY + Math.sin(wAngle) * wDist + driftY * 0.5;
      var wR = 0.25 * wisp.sizeBase * R;
      var wPulse = 1 + Math.sin(nowSec * 0.3 + wi * 1.5) * 0.15;
      wR *= wPulse;
      var wa = 0.05 * wisp.alphaBase;
      var c = colors[wisp.colorIdx % colors.length];
      var wGrad = orbCtx.createRadialGradient(wx, wy, 0, wx, wy, wR);
      wGrad.addColorStop(0, "rgba(" + c.r + "," + c.g + "," + c.b + "," + wa + ")");
      wGrad.addColorStop(0.5, "rgba(" + c.r + "," + c.g + "," + c.b + "," + (wa * 0.4) + ")");
      wGrad.addColorStop(1, "rgba(" + c.r + "," + c.g + "," + c.b + ",0)");
      orbCtx.fillStyle = wGrad;
      orbCtx.beginPath();
      orbCtx.arc(wx, wy, wR, 0, Math.PI * 2);
      orbCtx.fill();
    }
  }

  /* ---- FOG BODY (layered soft radial gradients, organically displaced) ---- */
  var fogD = 0.6;
  for (var layer = 0; layer < FOG_LAYERS; layer++) {
    var layerT = layer / (FOG_LAYERS - 1);
    var layerR = R * (0.25 + layerT * 0.8);
    var lAngle = (layer / FOG_LAYERS) * Math.PI * 2;
    var lMorph = getMorphAt(lAngle + nowSec * 0.05);
    var lx = CX + noise.noise2D(layer * 12 + nowSec * 0.06, 0) * R * 0.1 * lMorph + driftX;
    var ly = CY + noise.noise2D(0, layer * 12 + nowSec * 0.06) * R * 0.1 * lMorph + driftY;
    var layerAlpha = fogD * (0.2 - layerT * 0.1);
    var c = colors[layer % colors.length];
    var grad = orbCtx.createRadialGradient(lx, ly, 0, lx, ly, layerR * 1.2);
    grad.addColorStop(0, "rgba(" + c.r + "," + c.g + "," + c.b + "," + layerAlpha + ")");
    grad.addColorStop(0.6, "rgba(" + c.r + "," + c.g + "," + c.b + "," + (layerAlpha * 0.5) + ")");
    grad.addColorStop(1, "rgba(" + c.r + "," + c.g + "," + c.b + ",0)");
    orbCtx.fillStyle = grad;
    orbCtx.fillRect(0, 0, W, H);
  }

  /* ---- BLOBS (internal flowing fog motion with boundary fade) ---- */
  var blobCount = reducedMotion ? 6 : BLOB_COUNT;
  for (var i = 0; i < blobCount; i++) {
    var blob = blobs[i];
    var speed = blob.speedVariance;
    if (reducedMotion) speed *= 0.5;
    var phase = nowSec * (0.2 + (i * 0.07) + speed * 0.08) + blob.phaseOffset;
    var nx = noise.noise2D(blob.noiseSeed + nowSec * 0.15 * speed, i * 0.3);
    var ny = noise.noise2D(blob.noiseSeed + 100 + nowSec * 0.13 * speed, i * 0.3 + 50);
    var orbitR = blob.orbitRadius * R;
    var x = CX + Math.cos(phase) * orbitR + nx * orbitR * 0.5 + driftX * 0.3;
    var y = CY + Math.sin(phase * 0.9) * orbitR + ny * orbitR * 0.5 + driftY * 0.3;
    var blobR = R * 0.28 + Math.sin(phase * 1.7) * R * 0.05;
    /* Fade blobs near edge */
    var dfc = Math.sqrt((x - CX) * (x - CX) + (y - CY) * (y - CY));
    var bFade = Math.max(0, 1 - dfc / (R * 1.2));
    bFade = Math.pow(bFade, 0.6);
    var c = colors[blob.colorIdx % colors.length];
    var bGrad = orbCtx.createRadialGradient(x, y, 0, x, y, blobR);
    bGrad.addColorStop(0, "rgba(" + c.r + "," + c.g + "," + c.b + "," + (0.14 * bFade) + ")");
    bGrad.addColorStop(1, "rgba(" + c.r + "," + c.g + "," + c.b + ",0)");
    orbCtx.fillStyle = bGrad;
    orbCtx.fillRect(0, 0, W, H);
  }

  /* ---- INNER GLOW ---- */
  var ig = orbCtx.createRadialGradient(CX + driftX, CY + driftY, 0, CX, CY, R * 0.5);
  ig.addColorStop(0, "rgba(" + colors[0].r + "," + colors[0].g + "," + colors[0].b + ",0.2)");
  ig.addColorStop(1, "rgba(" + colors[0].r + "," + colors[0].g + "," + colors[0].b + ",0)");
  orbCtx.fillStyle = ig;
  orbCtx.fillRect(0, 0, W, H);

  /* ---- STARS (tiny twinkling points ‚Äî stars in fog) ---- */
  if (!reducedMotion) {
    for (var i = 0; i < stars.length; i++) {
      var st = stars[i];
      var age = nowSec - st.born;
      if (age > st.lifespan) {
        stars[i] = spawnStar(nowSec, st.outer);
        continue;
      }
      var lifeT = age / st.lifespan;
      var alpha = lifeT < 0.1 ? lifeT / 0.1 : lifeT > 0.8 ? (1 - lifeT) / 0.2 : 1.0;
      /* Twinkle */
      var twinkleVal = 0.4 + 0.6 * Math.sin(nowSec * st.twinkleRate + st.twinklePhase);
      alpha *= twinkleVal;
      /* Brightness */
      var baseA = st.outer ? 0.35 : 0.55;
      alpha *= st.bright ? baseA : (baseA * 0.6);
      if (alpha < 0.003) continue;

      var pNx = noise.noise2D(st.noiseSeed + nowSec * 0.08, st.noiseSeed * 0.3);
      var orbitSpeed = st.speed * (1 + (1 - st.dist) * 0.5);
      var sAngle = st.angle + nowSec * orbitSpeed;
      var sDist = st.dist * R * (st.outer ? 1.4 : 1) + pNx * R * 0.06;
      var sx = CX + Math.cos(sAngle) * sDist + driftX * (st.outer ? 0.2 : 0.4);
      var sy = CY + Math.sin(sAngle) * sDist + driftY * (st.outer ? 0.2 : 0.4);

      /* Edge fade for interior stars */
      if (!st.outer) {
        var dfc2 = Math.sqrt((sx - CX) * (sx - CX) + (sy - CY) * (sy - CY));
        var edgeFade = Math.max(0, 1 - dfc2 / (R * 1.15));
        edgeFade = Math.pow(edgeFade, 0.4);
        alpha *= edgeFade;
      }
      if (alpha < 0.003) continue;

      var sColor = colors[st.colorIdx % colors.length];
      var sSize = st.size * dpr;

      /* Tiny glow halo for bright stars */
      if (st.bright && alpha > 0.08) {
        var glowR = sSize * 2.5;
        var glow = orbCtx.createRadialGradient(sx, sy, 0, sx, sy, glowR);
        glow.addColorStop(0, "rgba(" + sColor.r + "," + sColor.g + "," + sColor.b + "," + (alpha * 0.3) + ")");
        glow.addColorStop(1, "rgba(" + sColor.r + "," + sColor.g + "," + sColor.b + ",0)");
        orbCtx.fillStyle = glow;
        orbCtx.fillRect(sx - glowR, sy - glowR, glowR * 2, glowR * 2);
      }

      orbCtx.beginPath();
      orbCtx.arc(sx, sy, sSize, 0, Math.PI * 2);
      orbCtx.fillStyle = "rgba(" + sColor.r + "," + sColor.g + "," + sColor.b + "," + alpha + ")";
      orbCtx.fill();
    }
  }

  orbCtx.restore(); /* Undo throb transform */

  /* Noise grain overlay */
  if (grainPattern) {
    var gx = (nowSec * 12 * dpr) % grainTileSize;
    var gy = (nowSec * 7 * dpr) % grainTileSize;
    orbCtx.save();
    orbCtx.globalAlpha = 0.025;
    orbCtx.translate(gx, gy);
    orbCtx.fillStyle = grainPattern;
    orbCtx.fillRect(-grainTileSize, -grainTileSize, W + grainTileSize * 2, H + grainTileSize * 2);
    orbCtx.restore();
  }
}

/* ---------------------------------------------------------
   9. Color Cycling ‚Äî smooth transitions through Scottish palette
   --------------------------------------------------------- */
function updateColorCycle(dt) {
  colorCycleT += dt * colorCycleSpeed;
  if (colorCycleT >= 1) {
    colorCycleT -= 1;
    colorCycleIdx = (colorCycleIdx + 1) % SCOTTISH_PALETTE.length;
  }
  var fromPal = SCOTTISH_PALETTE[colorCycleIdx];
  var toPal = SCOTTISH_PALETTE[(colorCycleIdx + 1) % SCOTTISH_PALETTE.length];
  var t = colorCycleT;
  /* Smoothstep for gentle transitions */
  t = t * t * (3 - 2 * t);
  orbColors = [
    lerpColorHex(fromPal.colors[0], toPal.colors[0], t),
    lerpColorHex(fromPal.colors[1], toPal.colors[1], t),
    lerpColorHex(fromPal.colors[2], toPal.colors[2], t)
  ];
}

/* ---------------------------------------------------------
   10. Animation Loop
   --------------------------------------------------------- */
var lastFrameTime = 0;
function loop(t) {
  var nowSec = t / 1000;
  var dt = lastFrameTime > 0 ? (t - lastFrameTime) / 1000 : 0.016;
  lastFrameTime = t;
  updateColorCycle(dt);
  drawOrb(nowSec);
  requestAnimationFrame(loop);
}

regenerateGrain();
requestAnimationFrame(loop);

/* =========================================================
   Screen State Machine
   ========================================================= */

var currentPhase = "welcome";  // welcome | permissions | ready
var permissionState = { microphone: "pending", contacts: "pending", calendar: "pending", mail: "pending" };

var screens = {
  welcome: document.getElementById("screenWelcome"),
  permissions: document.getElementById("screenPermissions"),
  ready: document.getElementById("screenReady")
};

var dots = [
  document.getElementById("dot0"),
  document.getElementById("dot1"),
  document.getElementById("dot2")
];

var phaseOrder = ["welcome", "permissions", "ready"];

function updateDots(phase) {
  var idx = phaseOrder.indexOf(phase);
  dots.forEach(function(d, i) {
    if (i === idx) {
      d.classList.add("active");
    } else {
      d.classList.remove("active");
    }
  });
}

function transitionTo(phase) {
  if (phase === currentPhase) return;

  var fromEl = screens[currentPhase];
  var toEl = screens[phase];

  /* Slide current screen to the left */
  fromEl.classList.add("exit-left");
  fromEl.classList.remove("active");

  setTimeout(function() {
    fromEl.classList.remove("exit-left");
    toEl.classList.add("active");
    currentPhase = phase;
    updateDots(phase);

    /* Adjust color cycling speed based on phase */
    if (phase === "permissions") {
      colorCycleSpeed = 0.12; /* Slightly slower during setup */
    } else if (phase === "ready") {
      colorCycleSpeed = 0.08; /* Gentle settling for ready state */
    }

    /* Notify Swift host of phase change */
    postToSwift("onboardingPhaseChanged", { phase: phase });
  }, 280);
}

/* ---------------------------------------------------------
   Permission Handling
   --------------------------------------------------------- */

/* Maps permission name ‚Üí { cardId, statusId, iconId, grantedIcon, pendingIcon } */
var PERMISSION_CARDS = {
  microphone: { cardId: "cardMic",      statusId: "statusMic",      iconId: "iconMic",      grantedIcon: "‚úÖ", pendingIcon: "üéôÔ∏è" },
  contacts:   { cardId: "cardContacts", statusId: "statusContacts", iconId: "iconContacts", grantedIcon: "‚úÖ", pendingIcon: "üë§" },
  calendar:   { cardId: "cardCalendar", statusId: "statusCalendar", iconId: "iconCalendar", grantedIcon: "‚úÖ", pendingIcon: "üìÖ" },
  mail:       { cardId: "cardMail",     statusId: "statusMail",     iconId: "iconMail",     grantedIcon: "‚úÖ", pendingIcon: "‚úâÔ∏è" }
};

function updatePermissionCard(permission, state) {
  permissionState[permission] = state;

  var meta = PERMISSION_CARDS[permission];
  if (!meta) return;

  var cardEl   = document.getElementById(meta.cardId);
  var statusEl = document.getElementById(meta.statusId);
  var iconEl   = document.getElementById(meta.iconId);

  if (!cardEl || !statusEl) return;

  /* Remove previous animation classes before re-applying */
  cardEl.classList.remove("animate-granted", "animate-denied");

  /* Trigger reflow so animation restarts if same state re-applied */
  void cardEl.offsetWidth; /* eslint-disable-line no-void */

  if (state === "granted") {
    statusEl.className = "permission-status granted";
    statusEl.textContent = "Granted";
    cardEl.classList.add("granted");
    cardEl.classList.add("animate-granted");

    /* Swap icon to checkmark with fade animation */
    if (iconEl) {
      iconEl.textContent = meta.grantedIcon;
      iconEl.classList.remove("icon-swap");
      void iconEl.offsetWidth; /* eslint-disable-line no-void */
      iconEl.classList.add("icon-swap");
    }

  } else if (state === "denied") {
    statusEl.className = "permission-status denied";
    statusEl.textContent = "Denied";
    cardEl.classList.remove("granted");
    cardEl.classList.add("animate-denied");

    /* Restore original icon */
    if (iconEl) {
      iconEl.textContent = meta.pendingIcon;
      iconEl.classList.remove("icon-swap");
      void iconEl.offsetWidth; /* eslint-disable-line no-void */
      iconEl.classList.add("icon-swap");
    }

  } else if (state === "settings") {
    /* "settings" state: System Settings was opened, user must configure manually */
    statusEl.className = "permission-status settings";
    statusEl.textContent = "Open Settings";
    cardEl.classList.remove("granted");

    /* Restore original icon */
    if (iconEl) {
      iconEl.textContent = meta.pendingIcon;
    }

  } else {
    statusEl.className = "permission-status";
    statusEl.textContent = "Allow";
    cardEl.classList.remove("granted");

    /* Restore original icon */
    if (iconEl) {
      iconEl.textContent = meta.pendingIcon;
    }
  }
}

/* Called by Swift to update permission UI after native dialog */
window.setPermissionState = function(permission, state) {
  updatePermissionCard(permission, state);
};

/* ---------------------------------------------------------
   Button Handlers
   --------------------------------------------------------- */
document.getElementById("btnWelcomeNext").addEventListener("click", function() {
  postToSwift("onboardingAdvance", {});
  transitionTo("permissions");
});

/* "Click anywhere to continue" on the welcome screen */
document.getElementById("screenWelcome").addEventListener("click", function(e) {
  /* Avoid double-advancing if the button itself was clicked */
  if (e.target.closest("#btnWelcomeNext")) return;
  postToSwift("onboardingAdvance", {});
  transitionTo("permissions");
});

document.getElementById("btnPermissionsNext").addEventListener("click", function() {
  postToSwift("onboardingAdvance", {});
  transitionTo("ready");
});

document.getElementById("btnReady").addEventListener("click", function() {
  postToSwift("onboardingComplete", {});
  /* Swift will dismiss this webview and show conversation */
});

/* Permission "Allow" buttons */
document.querySelectorAll(".permission-status").forEach(function(btn) {
  btn.addEventListener("click", function() {
    var permission = this.getAttribute("data-permission");
    if (permissionState[permission] === "granted") return;
    postToSwift("requestPermission", { permission: permission });
  });
});

/* Help "?" buttons */
document.querySelectorAll(".btn-help").forEach(function(btn) {
  btn.addEventListener("click", function() {
    var permission = this.getAttribute("data-permission");
    postToSwift("permissionHelp", { permission: permission });
  });
});

/* ---------------------------------------------------------
   Swift ‚Üí JS API
   --------------------------------------------------------- */
/* Set personalised name on ready screen */
window.setUserName = function(name) {
  var bubble = document.getElementById("readyBubble");
  if (name && name.trim()) {
    bubble.textContent = "Hello, " + name.trim() + ". I'm all set ‚Äî just speak. " +
      "Everything stays right here on your Mac.";
  }
};

/* Show download/load progress bar */
window.showProgress = function(type, message, pct) {
  var overlay = document.getElementById("progressOverlay");
  var label = document.getElementById("progressLabel");
  var fill = document.getElementById("progressFill");
  if (!overlay) return;
  overlay.classList.add("visible");
  if (label) label.textContent = message || "Loading‚Ä¶";
  if (fill) fill.style.width = Math.min(100, Math.max(0, pct || 0)) + "%";
};

/* Hide progress bar */
window.hideProgress = function() {
  var overlay = document.getElementById("progressOverlay");
  if (overlay) overlay.classList.remove("visible");
};

/* Restore onboarding to a specific phase (for resuming mid-onboarding) */
window.restorePhase = function(phase) {
  if (!screens[phase] || phase === currentPhase) return;
  /* Jump directly without slide animation */
  var currentEl = screens[currentPhase];
  if (currentEl) {
    currentEl.classList.remove("active");
    currentEl.classList.remove("exit-left");
  }
  screens[phase].classList.add("active");
  currentPhase = phase;
  updateDots(phase);
};

/* ---------------------------------------------------------
   Orb Entrance ‚Üí Float Transition
   When orbEntrance finishes, swap to the orbFloat animation
   by adding the "entered" class. A fallback timer ensures
   the float always activates even if animationend is missed
   (e.g. tab backgrounded during entrance).
   --------------------------------------------------------- */
var orbWrapperEl = document.getElementById("orbWrapper");
if (orbWrapperEl) {
  if (reducedMotion) {
    /* Skip entrance; mark as entered immediately */
    orbWrapperEl.classList.add("entered");
  } else {
    /* Transition entrance ‚Üí float on animationend */
    orbWrapperEl.addEventListener("animationend", function(e) {
      if (e.animationName === "orbEntrance") {
        orbWrapperEl.classList.add("entered");
      }
    });
    /* Fallback: guarantee entered class after entrance duration + buffer */
    setTimeout(function() {
      if (orbWrapperEl && !orbWrapperEl.classList.contains("entered")) {
        orbWrapperEl.classList.add("entered");
      }
    }, 1500);
  }
}

/* Signal ready */
postToSwift("ready", {});
</script>
</body>
</html>
