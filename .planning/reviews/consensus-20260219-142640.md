# Consensus Review Report

**Date**: 2026-02-19T14:26:40Z
**Mode**: gsd (task diff)
**Phase**: 5.1 — Device Handoff
**Task**: 8 — Integration Test Plan for Handoff Scenarios
**Iteration**: 1

## Reviewer Grades

| Reviewer | Grade | File |
|----------|-------|------|
| Error Handling | A | error-handling.md |
| Security | A | security.md |
| Code Quality | B | code-quality.md |
| Documentation | A | documentation.md |
| Test Coverage | B | test-coverage.md |
| Type Safety | A | type-safety.md |
| Complexity | A | complexity.md |
| Build | A | build.md |
| Task Spec | B | task-spec.md |
| Quality Patterns | B | quality-patterns.md |
| Codex | B | codex.md |
| Kimi K2 | B | kimi.md (unavailable, manual assessment) |
| GLM-4.7 | B | glm.md (unavailable, manual assessment) |
| MiniMax | B | minimax.md (unavailable, manual assessment) |
| Code Simplifier | B | code-simplifier.md |

## Build Validation

| Check | Status |
|-------|--------|
| cargo check | PASS |
| cargo clippy | PASS |
| cargo nextest run (2493 tests) | PASS |
| cargo fmt | PASS |

## Consensus Tally

| Finding | ERR | SEC | QUAL | DOC | TEST | TYPE | CMPLX | BUILD | TASK | PTRN | CODEX | KIMI | GLM | MINI | SMPL | Total | Verdict |
|---------|-----|-----|------|-----|------|------|-------|-------|------|------|-------|------|-----|------|------|-------|---------|
| Force-unwrap `snapshotJSON!` should use XCTUnwrap | | | | | | | | | | | ✓ | | | ✓ | ✓ | 3/15 | SHOULD FIX |
| TestDeviceCommandParser duplicates production logic (maintenance risk) | | | ✓ | | | | | | | ✓ | | ✓ | ✓ | ✓ | | 5/15 | MUST FIX |
| Path discrepancy: spec says FaeNativeAppTests/, actual is HandoffTests/ | | | | | | | | | ✓ | | | | ✓ | ✓ | | 3/15 | SHOULD FIX |
| HandoffKVStore unit tests not automated (deferred to manual) | | | | | ✓ | | | | ✓ | | | ✓ | | | | 3/15 | SHOULD FIX |
| testSnapshotCappingToMaxEntries does not test struct's own capping | | | | | | | | | | | | ✓ | | | ✓ | 2/15 | SHOULD FIX |
| go-home patterns could be consolidated | | | | | | | ✓ | | | | | | | | ✓ | 2/15 | SHOULD FIX |

## Notes on Verdicts

### Finding 1: Force-unwrap (3 votes — SHOULD FIX)
`snapshotJSON!` and `receivedJSON!.data(using: .utf8)!` in `testHandoffPayloadWithSnapshot`.
Replace `snapshotJSON!` with `try XCTUnwrap(snapshotJSON)` and `receivedJSON!` with `try XCTUnwrap(receivedJSON)`.
This provides better test failure messages. LOW severity — tests still function correctly.

### Finding 2: TestDeviceCommandParser duplication (5 votes — MUST FIX)
The parser is copied from production because tests cannot link against libfae.a.
MODERATE severity — this is architecturally constrained but creates a maintenance trap.
Mitigation: Add a comment linking to the canonical production location and the git line to update.
Ideal fix: Expose parser logic through FaeHandoffKit so tests import it directly.
(Full extraction to FaeHandoffKit is beyond task 8 scope — add explicit sync comment.)

### Finding 3: Path discrepancy (3 votes — SHOULD FIX)
Spec: `Tests/FaeNativeAppTests/HandoffTests.swift`
Actual: `Tests/HandoffTests/HandoffTests.swift`
The Package.swift correctly points to actual path. Update PLAN-phase-5.1.md to match actual path, or note this as an acceptable deviation.

### Finding 4: HandoffKVStore not unit-tested (3 votes — SHOULD FIX)
Task 8 spec explicitly required unit tests for HandoffKVStore with mock store.
The implementation defers to manual test plan because `NSUbiquitousKeyValueStore.default` is a singleton.
Protocol-based injection would enable mockable unit tests. This is a gap vs. spec.

### Finding 5: Snapshot capping not truly tested (2 votes — SHOULD FIX)
`testSnapshotCappingToMaxEntries` passes a pre-capped array to `ConversationSnapshot.init`.
If the struct's initializer enforces capping, this test does not exercise that code path.
If the struct does NOT auto-cap and the caller is responsible for capping, the test is correct.
Need to verify whether `ConversationSnapshot.init` auto-caps — if so, update test to pass oversized array directly.

### Finding 6: go-home pattern consolidation (2 votes — SHOULD FIX)
Minor simplification opportunity — combine separate if-blocks for "go home"/"move home" and "back to mac" into a single check.

## Summary

- MUST FIX (4+ votes): **1 issue** (TestDeviceCommandParser duplication — add sync comment)
- SHOULD FIX (2-3 votes): **5 issues** (XCTUnwrap, path doc, KVStore gap, capping test, pattern consolidation)
- DISPUTED (1 vote): **0 issues**

## Overall Verdict

**CONDITIONAL**

The build is fully green (zero errors, zero warnings, 2493 tests passing). The implementation quality is high and the manual test plan is comprehensive. The primary gaps are:

1. One MUST FIX: `TestDeviceCommandParser` duplication needs an explicit sync comment pointing to production source of truth.
2. Several SHOULD FIX items are low-severity quality improvements that won't block the phase.
3. The HandoffKVStore testing gap is a spec deviation but is architecturally justified.

**Recommended action**: Apply the MUST FIX (add sync comment to `TestDeviceCommandParser`) and the XCTUnwrap improvements, then mark review as passed.
