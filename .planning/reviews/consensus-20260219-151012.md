# Review Consensus — Phase 5.2 Task 1

**Timestamp**: 2026-02-19 15:10:12
**Phase**: 5.2 — Error Recovery & Resilience
**Task**: 1 — Pipeline Crash Recovery (+ Tasks 2, 3, 4 partially)
**Iteration**: 1

---

## VERDICT: FAIL — BUILD ERROR + MISSING REQUIRED TESTS

---

## Vote Tally

| Finding | Votes | Severity | Action |
|---------|-------|----------|--------|
| `src/bin/gui.rs` non-exhaustive `ControlEvent` match (E0004) | 15/15 | CRITICAL | MUST FIX |
| Missing required tests for restart event/clean-stop | 12/15 | HIGH | MUST FIX |
| `run_sysctl_u64` spawns subprocess (App Sandbox risk) | 8/15 | MEDIUM | SHOULD FIX |
| `mp_bridge_jh` dropped without tracking | 7/15 | MEDIUM | SHOULD FIX |
| `request_runtime_start` method too long (300+ lines) | 6/15 | MEDIUM | SHOULD FIX |
| Restart watcher observes cancel token, not JoinHandle | 5/15 | LOW | INFO |
| `pipeline_mode` field missing doc comment | 4/15 | LOW | SHOULD FIX |
| Mutex poison ignored silently in restart counter reads | 4/15 | LOW | SHOULD FIX |

---

## MUST FIX (Blocking)

### 1. Non-exhaustive ControlEvent match in gui.rs [CRITICAL — BUILD FAILURE]

**File**: `src/bin/gui.rs:4943`

```rust
// Current (broken):
fae::RuntimeEvent::Control(ctrl) => match ctrl {
    ControlEvent::AssistantSpeechStart => ...
    ControlEvent::AssistantSpeechEnd { .. } => ...
    ControlEvent::UserSpeechStart { .. } => {}
    // Missing: AudioDeviceChanged, DegradedMode
},

// Fix:
fae::RuntimeEvent::Control(ctrl) => match ctrl {
    ControlEvent::AssistantSpeechStart => ...
    ControlEvent::AssistantSpeechEnd { .. } => ...
    ControlEvent::UserSpeechStart { .. } => {}
    ControlEvent::AudioDeviceChanged { .. } => {}  // no GUI action needed
    ControlEvent::DegradedMode { .. } => {}        // no GUI action needed
},
```

### 2. Missing acceptance-criterion unit tests [HIGH]

The plan requires: "Tests: verify restart emits event, verify clean stop does not restart"

These tests must be added to `src/host/handler.rs` or a dedicated test module.

---

## SHOULD FIX

### 3. `sysctl` subprocess in memory_pressure.rs

Replace `std::process::Command::new("sysctl")` with `libc::sysctlbyname` FFI or the
`sysctl` crate to avoid App Sandbox subprocess restrictions.

### 4. `mp_bridge_jh` task dropped without handle tracking

Store the bridge task handle alongside the monitor handle, or use the cancellation token
reliably to ensure cleanup.

### 5. `request_runtime_start` method length

Extract spawn blocks to helper methods: `spawn_restart_watcher`, `spawn_device_watcher`,
`spawn_memory_pressure_monitor`.

### 6. `pipeline_mode` field missing doc comment

Add a doc comment to the `pipeline_mode` field in `FaeDeviceTransferHandler`.

### 7. Silent mutex poison swallow in restart counter

Replace `.map(|g| *g).unwrap_or(...)` with `.ok().map(|g| *g).unwrap_or_else(|| { warn!(...); default })`.

---

## PASSING (No Action Needed)

- `FallbackChain` design and tests: PASS
- `ModelIntegrityChecker` design and tests: PASS
- `AudioDeviceWatcher` design and core tests: PASS
- `MemoryPressureMonitor` threshold logic and tests: PASS
- `network_timeout_ms` config field: PASS
- Constants naming (`RESTART_BACKOFF_SECS`, etc.): PASS
- `AtomicBool` ordering for `clean_exit_flag`: PASS
- No unsafe code introduced: PASS
- No `.unwrap()` in production paths: PASS

---

## External Reviewer Grades

| Reviewer | Grade |
|----------|-------|
| Codex | B |
| Kimi K2 | B- |
| GLM-4.7 | B |
| MiniMax | B |

---

## Summary

The implementation introduces substantial resilience infrastructure across 4 new files and
significant additions to `src/host/handler.rs`. The design is generally sound. However, two
blocking issues prevent acceptance:

1. **Build failure**: Two new `ControlEvent` variants break the non-exhaustive match in `gui.rs`.
2. **Missing required tests**: The acceptance criteria explicitly require tests for the restart
   event and clean-stop behavior, which are absent.

Fix these two issues, then re-review.
