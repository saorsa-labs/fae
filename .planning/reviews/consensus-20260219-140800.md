# Consensus Review Report
**Phase**: 5.1 — Device Handoff
**Task**: 1 — Conversation Snapshot in NSUserActivity
**Timestamp**: 2026-02-19T14:08:00Z
**Reviewers**: 15 (Error Handling, Security, Code Quality, Documentation, Test Coverage, Type Safety, Complexity, Build, Task Assessor, Quality Patterns, Codex, Kimi K2, GLM-4.7, MiniMax, Code Simplifier)
**Iterations**: 1

---

## VERDICT: FAIL — Task Incomplete

The core serialisation logic is implemented correctly, but the task has 2 unfulfilled acceptance criteria (tests and ConversationController changes). Multiple reviewers flagged these as critical blockers.

---

## Vote Tally

| Finding ID | Description | Severity | Votes | Consensus |
|------------|-------------|----------|-------|-----------|
| TC-1 / TASK-2 / CODEX-1 / KIMI-1 / GLM-1 / MINI-1 | No unit tests added (explicit AC requirement) | CRITICAL | 6/15 | **MUST FIX** |
| TASK-1 / CQ-1 / CODEX-2 / KIMI-2 / GLM-4 / MINI-2 | ConversationController.messages accessor not added | HIGH | 6/15 | **MUST FIX** |
| TC-2 | snapshotProvider closure not tested | HIGH | 1/15 | **MUST FIX** |
| EH-1 / KIMI-3 / MINI-3 | Silent try? swallows encoding errors (no logging) | MEDIUM | 3/15 | **SHOULD FIX** |
| SEC-1 / GLM-2 | No size limit on conversationSnapshot (NSUserActivity payload limit) | MEDIUM | 2/15 | **SHOULD FIX** |
| TASK-3 | Role filtering not enforced at serialisation boundary | HIGH | 1/15 | **SHOULD FIX** |
| TS-1 / KIMI-4 / MINI-4 | SnapshotEntry.role is String not enum | LOW | 3/15 | **SHOULD FIX** |
| CQ-3 / BUILD-2 / SIMP-2 | Magic activityType string — should use FaeHandoffContract.activityType | MEDIUM | 3/15 | **SHOULD FIX** |
| BUILD-1 | ConversationSnapshot/SnapshotEntry should be in FaeHandoffKit, not app layer | MEDIUM | 1/15 | **SHOULD FIX** |
| SEC-2 | No user consent / no enforcement that provider filters correctly | MEDIUM | 1/15 | **SHOULD FIX** |
| QP-4 | ConversationSnapshot/SnapshotEntry missing Sendable conformance | LOW | 1/15 | INFO |
| DOC-1 | snapshotProvider contract not fully documented | LOW | 1/15 | INFO |
| CPLX-1 | Snapshot enrichment should be extracted to own method | LOW | 1/15 | INFO |
| SEC-3 | No schemaVersion field in ConversationSnapshot | LOW | 1/15 | INFO |

---

## MUST FIX (Blocking)

### 1. Add unit tests (TC-1) [6 votes — CRITICAL]
The task acceptance criteria explicitly requires: "Add unit tests for snapshot encoding/decoding and role filtering." No tests were added in this commit.

**Action**: Add to FaeHandoffKitTests or a new ConversationSnapshotTests.swift:
- `testSnapshotRoundTrip()` — encode/decode ConversationSnapshot
- `testSnapshotRoleFiltering()` — verify only user/assistant roles survive
- `testSnapshotProviderNil()` — verify activity degrades without snapshot
- `testEncodingFailureDegrades()` — verify encoding error is handled

### 2. Add ConversationController.messages public accessor (TASK-1) [6 votes — HIGH]
The task AC says: "Snapshot is built from ConversationController.messages (add public accessor if needed)." ConversationController.swift has zero changes.

**Action**: Expose `private(set) var messages` as `@Published private(set)` or add a computed accessor. Wire snapshotProvider from the app layer.

### 3. Test snapshotProvider closure (TC-2) [1 vote — HIGH]
The provider closure is the primary integration point. It must be covered by tests.

**Action**: Test both nil provider case and non-nil provider case.

---

## SHOULD FIX

### 4. Log encoding failures instead of silent try? (EH-1) [3 votes]
```swift
// Before:
if let data = try? snapshotEncoder.encode(provider()) { ... }

// After:
do {
    let data = try snapshotEncoder.encode(provider())
    if let json = String(data: data, encoding: .utf8) {
        info["conversationSnapshot"] = json
    }
} catch {
    NSLog("[DeviceHandoff] snapshot encode failed: %@", error.localizedDescription)
}
```

### 5. Add size limit on snapshot (SEC-1) [2 votes]
NSUserActivity userInfo has platform limits. Truncate entries to last 20 before encoding.

### 6. Use FaeHandoffContract.activityType constant (CQ-3) [3 votes]
Replace `"com.saorsalabs.fae.session.handoff"` with `FaeHandoffContract.activityType`.

### 7. Type SnapshotEntry.role as enum (TS-1) [3 votes]
```swift
enum SnapshotRole: String, Codable { case user, assistant }
```

---

## INFO (Non-blocking)

- Sendable conformance on snapshot structs
- Extract snapshotJSON() helper method
- Schema version field for future compatibility
- Provider contract documentation

---

## Grades by Reviewer

| Reviewer | Grade |
|----------|-------|
| Error Handling | C+ |
| Security | C+ |
| Code Quality | B- |
| Documentation | B |
| Test Coverage | D |
| Type Safety | B- |
| Complexity | A- |
| Build | B |
| Task Assessor | FAIL (2 AC unmet) |
| Quality Patterns | B+ |
| Codex | C+ |
| Kimi K2 | C |
| GLM-4.7 | B- |
| MiniMax | C+ |
| Code Simplifier | A |

**Consensus Grade: C+ (blocked by missing tests and ConversationController changes)**

---

## Build Status

Rust codebase: N/A for this task (Swift only change)
Swift compilation: Passes (syntactically correct)
Swift tests: NOT run (no test changes; existing FaeHandoffKit tests pass)

---

## Action Items Summary

| # | Item | Priority |
|---|------|----------|
| 1 | Add unit tests for ConversationSnapshot encode/decode/role-filter | CRITICAL |
| 2 | Add ConversationController.messages accessor | HIGH |
| 3 | Log encoding errors instead of silent try? | MEDIUM |
| 4 | Add payload size limit (max 20 entries) | MEDIUM |
| 5 | Use FaeHandoffContract.activityType constant | MEDIUM |
| 6 | Type SnapshotEntry.role as enum | LOW |
