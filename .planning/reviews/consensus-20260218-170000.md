# Review Consensus Report
**Phase 1.3 — Task 5: Wire Capability Bridge (End-to-End)**
**Timestamp:** 2026-02-18 17:00:00
**Iteration:** 1

---

## Overall Verdict: PASS

**Build:** PASS (zero errors, zero warnings, zero format violations)
**Test suite (task scope):** ALL PASS (10 unit + 15 capability e2e + 6 contract roundtrip = 31 tests)
**Pre-existing failure:** `update::applier::tests::cleanup_old_backup_removes_backup` — pre-existing flaky test, NOT in task scope

---

## Reviewer Votes Summary

| Reviewer | CRITICAL | HIGH | MEDIUM | LOW | Verdict |
|----------|----------|------|--------|-----|---------|
| error-handling | 0 | 0 | 0 | 2 | PASS |
| security | 0 | 0 | 0 | 2 | PASS |
| code-quality | 0 | 0 | 0 | 2 | PASS |
| documentation | 0 | 0 | 0 | 2 | PASS |
| test-coverage | 0 | 0 | 1 | 2 | PASS |
| type-safety | 0 | 0 | 0 | 2 | PASS |
| complexity | 0 | 0 | 0 | 2 | PASS |
| build | 0 | 0 | 0 | 0 | PASS |
| task-spec | 0 | 0 | 0 | 0 | PASS |
| quality-patterns | 0 | 0 | 0 | 2 | PASS |
| codex | 0 | 0 | 1 | 3 | PASS |
| kimi | 0 | 0 | 1 | 3 | PASS |
| glm | 0 | 0 | 2 | 2 | PASS |
| minimax | 0 | 0 | 1 | 2 | PASS |
| code-simplifier | 0 | 0 | 0 | 3 | PASS |
| **TOTAL** | **0** | **0** | **7** | **31** | **PASS** |

---

## Consensus Findings (2+ votes required)

### MEDIUM — Missing roundtrip tests for CapabilityDeny, OnboardingGetState, OnboardingComplete
**Votes:** 5/15 reviewers (test-coverage, codex, kimi, glm, minimax)
**Action:** SHOULD FIX

The project has established serde roundtrip tests in `tests/host_contract_v0.rs` for each `CommandName` variant. Three new variants are missing coverage:
- `CapabilityDeny` → "capability.deny"
- `OnboardingGetState` → "onboarding.get_state"
- `OnboardingComplete` → "onboarding.complete"

```rust
// Add to tests/host_contract_v0.rs:
#[test]
fn command_name_capability_deny_roundtrip() {
    let name = CommandName::CapabilityDeny;
    let wire = name.as_str();
    assert_eq!(wire, "capability.deny");
    let parsed = CommandName::parse(wire).expect("parse capability.deny");
    assert_eq!(parsed, name);
    let json = serde_json::to_value(name).expect("serialize CapabilityDeny");
    assert_eq!(json, "capability.deny");
    let deserialized: CommandName = serde_json::from_value(json).expect("deserialize CapabilityDeny");
    assert_eq!(deserialized, name);
}
// (similar tests for OnboardingGetState, OnboardingComplete)
```

---

### LOW — Silent error swallow in ffi.rs handler initialization
**Votes:** 5/15 reviewers (error-handling, codex, kimi, minimax, glm)
**Action:** SHOULD FIX

```rust
// Current:
Err(_) => FaeDeviceTransferHandler::new(...)

// Fix:
Err(e) => {
    tracing::warn!("Failed to load config from default path, using defaults: {e}");
    FaeDeviceTransferHandler::new(...)
}
```

---

### LOW — Repeated Mutex lock-acquire pattern (6x)
**Votes:** 5/15 reviewers (code-quality, code-simplifier, codex, kimi, minimax)
**Action:** SHOULD FIX (DRY improvement)

Extract to: `fn lock_config(&self) -> Result<std::sync::MutexGuard<SpeechConfig>>`

---

### LOW — Trait method documentation missing on 3 new DeviceTransferHandler methods
**Votes:** 4/15 reviewers (documentation, codex, glm, code-quality)
**Action:** SHOULD FIX

`deny_capability`, `query_onboarding_state`, `complete_onboarding` need `///` doc comments.

---

### LOW — `handle_capability_deny` reuses `parse_capability_grant` (misleading naming)
**Votes:** 3/15 reviewers (security, kimi, type-safety)
**Action:** MAY FIX (low priority)

---

## Single-vote Findings (informational only)

- `save_config` acquires lock twice per grant/deny operation (simplifier)
- OrbWebView.swift resource subdirectory removal (quality-patterns) — change is intentional
- NSWindowAccessor in .background() is unconventional SwiftUI (complexity)
- `query_config_get` wildcard arm returns empty JSON silently (error-handling)

---

## Exit Criteria Check

| Criterion | Status |
|-----------|--------|
| Zero CRITICAL findings | PASS |
| Zero HIGH findings | PASS |
| Build passes | PASS |
| All external grades B or higher | PASS (all B or B+) |

---

## Action Items

1. **SHOULD FIX**: Add roundtrip tests for `CapabilityDeny`, `OnboardingGetState`, `OnboardingComplete` in `tests/host_contract_v0.rs`
2. **SHOULD FIX**: Log swallowed error in `ffi.rs` handler initialization fallback
3. **SHOULD FIX**: Extract `lock_config()` helper to remove repeated Mutex lock boilerplate
4. **SHOULD FIX**: Add `///` doc comments to three new `DeviceTransferHandler` trait methods

**These are SHOULD FIX items (no CRITICAL or HIGH). The task PASSES review.**
