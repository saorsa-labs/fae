# Consensus Review Report

**Date**: 2026-02-19T13:58:00Z
**Mode**: gsd (phase plan review)
**Phase**: 5.1 — Device Handoff
**Iteration**: 1

## Build Status

| Check | Status |
|-------|--------|
| cargo check --all-features | PASS |
| cargo clippy -- -D warnings | PASS (0 warnings) |
| cargo nextest run | PASS (2493/2493, 4 skipped) |
| cargo fmt --all -- --check | PASS |

Build is clean. No implementation code was changed in this session.

## Reviewer Grades

| Reviewer | Grade | Key Finding |
|----------|-------|-------------|
| Error Handling | B | KV store unavailable when iCloud not signed in |
| Security | B | Conversation snapshot must exclude memory data |
| Code Quality | B- | Plan not written to disk; singleton anti-pattern |
| Documentation | B | Plan file not on disk; missing DeviceHandoffConfig docs |
| Test Coverage | C+ | HandoffKVStore not testable without iCloud; no Mac-layer tests |
| Type Safety | B+ | entries_json double-encoding needs CodingKeys |
| Complexity | B | Orb flash routing is 3-layer when 1 would suffice |
| Build | A (build) / F (deliverable) | Plan not written to disk |
| Task Assessor | D | PLAN-phase-5.1.md not written — primary deliverable missing |
| Quality Patterns | B | HandoffKVStore singleton anti-pattern |
| Codex | B- | NSUbiquitousKeyValueStore.synchronize() deprecated; sessionId undefined |
| Kimi K2 | N/A | CLI unavailable (nested Claude session) |
| GLM-4.7 | N/A | CLI unavailable (nested Claude session) |
| MiniMax | N/A | CLI unavailable (nested Claude session) |
| Code Simplifier | B+ | FaeHandoffPayload could use nested struct; enum KV store |

## Consensus Tally

| Finding | ERR | SEC | QUAL | DOC | TEST | TYPE | CMPLX | BUILD | TASK | PTRN | CODEX | Total | Verdict |
|---------|-----|-----|------|-----|------|------|-------|-------|------|------|-------|-------|---------|
| PLAN NOT WRITTEN TO DISK | | | ✓ | ✓ | | | | ✓ | ✓ | | | 4/11 | **MUST FIX** |
| HandoffKVStore unavailable without iCloud | ✓ | | | | ✓ | | | | | ✓ | | 3/11 | **MUST FIX** |
| HandoffKVStore not unit testable (singleton) | | | ✓ | | ✓ | | | | | ✓ | | 3/11 | **MUST FIX** |
| Conversation snapshot may include sensitive memory | | ✓ | | | | | | | | | ✓ | 2/11 | **MUST FIX** |
| entries_json needs custom CodingKeys | | | | | | ✓ | | | | | ✓ | 2/11 | **SHOULD FIX** |
| sessionId: String? has no defined source | | | ✓ | | | ✓ | | | | | ✓ | 3/11 | **SHOULD FIX** |
| NSUbiquitousKeyValueStore.synchronize() deprecated | | | | | | | | | | | ✓ | 1/11 | OPUS DECIDES |
| Orb flash 3-layer routing is overcomplex | | | ✓ | | | | ✓ | | | ✓ | | 3/11 | **SHOULD FIX** |
| receiveHandoff() not tested in FaeNativeApp layer | | | | | ✓ | | | | ✓ | | | 2/11 | **SHOULD FIX** |
| Offline detection: timer vs NWPathMonitor | | | | | | | ✓ | | | | ✓ | 2/11 | **SHOULD FIX** |
| NSUbiquitousKeyValueStore 1MB limit | | | | | | | | | | | | 0/11 | SKIP |
| DeviceHandoffConfig needs doc comments | | | ✓ | ✓ | | | | | | | | 2/11 | **SHOULD FIX** |

## MUST FIX Items (4)

### 1. PLAN NOT WRITTEN TO DISK [4/11 votes — CRITICAL]
**Finding**: `.planning/PLAN-phase-5.1.md` contains the old Local LLM HTTP Server plan.
The Device Handoff plan produced in this session exists only as conversation output.
**Fix**: The plan MUST be written to `.planning/PLAN-phase-5.1.md` before any
dev-agent can execute Phase 5.1. The `plans/PLAN-phase-5.1.md` subdirectory file
also has the old content.

### 2. HandoffKVStore graceful degradation when iCloud unavailable [3/11 votes]
**Finding**: Plan Task 2 does not specify behavior when `NSUbiquitousKeyValueStore`
is unavailable (user not signed in to iCloud, enterprise MDM blocks it, etc.).
The KV store will silently fail — `synchronize()` is a no-op, reads return nil.
**Fix**: Plan must specify: `load()` returns nil gracefully, `save()` is a no-op
with an `NSLog` warning when iCloud is unavailable. No user-visible error.

### 3. HandoffKVStore not unit testable as singleton [3/11 votes]
**Finding**: `static let shared = HandoffKVStore()` wrapping `NSUbiquitousKeyValueStore.default`
makes it impossible to test without real iCloud. All CI environments lack iCloud access.
**Fix**: Plan must specify either (a) `HandoffKVStoreProtocol` with a mock
for testing, or (b) enum-namespace design (`enum HandoffKVStore { static func save(...) }`
with an injectable store parameter for tests).

### 4. Conversation snapshot must exclude sensitive memory data [2/11 votes]
**Finding**: Plan Task 1 serializes "conversation entries" into the NSUserActivity payload
and iCloud KV store. The Rust `RuntimeEvent::ConversationSnapshot` entries include ALL
pipeline context. Memory recall hits (private long-term memory) must NOT flow through
Apple's Handoff infrastructure.
**Fix**: Plan must specify a filter: only role="user" and role="assistant" display-layer
turns are included. Memory operations (MemoryRecall, MemoryWrite) are excluded.

## SHOULD FIX Items (5)

### 5. entries_json encoding needs custom CodingKeys [2/11 votes]
FaeHandoffPayload.conversationEntries is `[FaeHandoffEntry]?` but stored under
key `"entries_json"` as a JSON String. Swift's Codable won't auto-handle this.
Plan should specify custom encoding in `encode(to:)` / `init(from:)`.

### 6. Remove sessionId or define its source [3/11 votes]
`sessionId: String?` was added to FaeHandoffPayload but no existing code generates
a session ID. Either define it (UUID at pipeline start, persisted in config) or remove it.

### 7. Simplify orb flash path [3/11 votes]
Plan routes handoff flash through 3 notification hops. Simpler: `DeviceHandoffController`
directly calls `orbState?.mode = .thinking` via a weak reference, or calls
`hostBridge.sender?.sendCommand("orb.flash", payload: ["flash_type": "handoff_transfer"])`.

### 8. Test receiveHandoff() at the FaeNativeApp layer [2/11 votes]
The 4 planned unit tests are all in FaeHandoffKit (a separate package). The receive
path in FaeNativeApp has no automated test. Plan should add integration test or
extract restore logic to a testable free function.

### 9. Prefer NWPathMonitor over timer for offline detection [2/11 votes]
10s timer for offline detection is arbitrary and has no cancellation on app background.
`NWPathMonitor` provides real-time connectivity status without a polling timer.

## Opus Verdict on Disputed Item

### NSUbiquitousKeyValueStore.synchronize() [1/11 votes — Codex only]
The `synchronize()` call is indeed deprecated since macOS 10.15 per Apple docs.
However, the plan currently does not specify calling it explicitly — Codex flagged
it as an anticipatory concern. **VERDICT: SKIP** (plan doesn't call it explicitly;
implementer should simply omit it, relying on automatic sync).

## Summary

- MUST FIX (3-4 votes): **4 issues**
- SHOULD FIX (2-3 votes): **5 issues**
- DISPUTED (1 vote → Opus): 1 issue → SKIP
- Build: PASS (code unchanged)

## Overall Verdict

**CONDITIONAL — Plan content is strong but has 4 MUST FIX items before implementation**

The Phase 5.1 Device Handoff plan content is technically solid and comprehensive.
The codebase exploration was thorough. All 8 roadmap tasks are addressed. The
architecture diagram and per-task acceptance criteria are high quality.

**However, the primary deliverable (writing the plan to disk) was not completed.**
The existing `.planning/PLAN-phase-5.1.md` contains the WRONG plan content (LLM
Server). This MUST be fixed before any task execution. Additionally, 3 design
issues must be addressed in the plan: KV store graceful degradation, testability,
and privacy (memory data exclusion).

## GSD_REVIEW_RESULT

```
REVIEW_STATUS: CONDITIONAL
MUST_FIX_COUNT: 4
SHOULD_FIX_COUNT: 5
BUILD_STATUS: PASS
ALL_TESTS_PASS: YES (2493/2493)
EXTERNAL_REVIEWERS: UNAVAILABLE (nested Claude session)
RECOMMENDATION: Fix MUST FIX items, then proceed to task execution
PRIMARY_BLOCKER: PLAN-phase-5.1.md not written to disk
```
